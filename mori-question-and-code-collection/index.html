<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="theme-color" content="#0078E7"><meta name="author" content="harumonia"><meta name="copyright" content="harumonia"><meta name="generator" content="Hexo 6.0.0"><meta name="theme" content="hexo-theme-yun"><title>Mori Kokoro 开发过程中遇到的问题(2) 以及使用代码收集 | Zaxon</title><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@900&amp;display=swap" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/star-markdown-css@0.1.25/dist/yun/yun-markdown.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prism-theme-vars/base.css"><script src="//at.alicdn.com/t/font_1140697_j5gk85dg4pf.js" async></script><script src="https://cdn.jsdelivr.net/npm/scrollreveal/dist/scrollreveal.min.js" defer></script><script>function initScrollReveal() {
  [".post-card",".markdown-body img",".post-content img"].forEach((target)=> {
    ScrollReveal().reveal(target);
  })
}
document.addEventListener("DOMContentLoaded", initScrollReveal);
document.addEventListener("pjax:success", initScrollReveal);</script><link rel="icon" type="image/svg+xml" href="/yun.svg"><link rel="mask-icon" href="/yun.svg" color="#0078E7"><link rel="preload" href="/css/hexo-theme-yun.css" as="style"><link rel="preload" href="/js/utils.js" as="script"><link rel="preload" href="/js/hexo-theme-yun.js" as="script"><link rel="prefetch" href="/js/sidebar.js" as="script"><link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin><link rel="preconnect" href="https://cdn.jsdelivr.net/npm/" crossorigin><script id="yun-config">window.Yun={},window.CONFIG={hostname:"blog.harumonia.moe",root:"/",title:"迷雾中的藏宝地",version:"1.10.9",mode:"auto",copycode:!0,page:{isPost:!0},i18n:{placeholder:"搜索...",empty:"找不到您查询的内容: ${query}",hits:"找到 ${hits} 条结果",hits_time:"找到 ${hits} 条结果（用时 ${time} 毫秒）"},anonymous_image:"https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/avatar/none.jpg",say:{api:"https://v1.hitokoto.cn",hitokoto:!0},fireworks:{colors:["102, 167, 221","62, 131, 225","33, 78, 194"]},vendors:{host:"https://cdn.jsdelivr.net/npm/",darken:"https://cdn.jsdelivr.net/npm/darken@1.5.0"}}</script><link rel="stylesheet" href="/css/hexo-theme-yun.css"><script src="/js/hexo-theme-yun.js" type="module"></script><script src="/js/utils.js"></script><script src="/js/hexo-theme-yun.js"></script><link rel="alternate" href="/atom.xml" title="Zaxon" type="application/atom+xml"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin><script async src="https://www.googletagmanager.com/gtag/js?id=G-EBNGE3F0F6"></script><script>function gtag(){dataLayer.push(arguments)}CONFIG.hostname===location.hostname&&(window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-EBNGE3F0F6"))</script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><meta name="description" content="前言距离 Mori v0.1 成形已经过了一周.这一周里面对这个代码进行了进一步的优化. 在 Mori Kokoro 开发记录 中已经对上个阶段开发中遇到的问题进行了一次汇总.本篇是对本阶段的问题的汇总. 另外.将一些实用的代码摘出.并进行注释说明."><meta property="og:type" content="article"><meta property="og:title" content="Mori Kokoro 开发过程中遇到的问题(2) 以及使用代码收集"><meta property="og:url" content="https://blog.harumonia.moe/mori-question-and-code-collection/index.html"><meta property="og:site_name" content="Zaxon"><meta property="og:description" content="前言距离 Mori v0.1 成形已经过了一周.这一周里面对这个代码进行了进一步的优化. 在 Mori Kokoro 开发记录 中已经对上个阶段开发中遇到的问题进行了一次汇总.本篇是对本阶段的问题的汇总. 另外.将一些实用的代码摘出.并进行注释说明."><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://harumona-blog.oss-cn-beijing.aliyuncs.com/new_articles/mori.gif"><meta property="article:published_time" content="2020-11-10T10:52:26.000Z"><meta property="article:modified_time" content="2020-11-19T17:03:26.000Z"><meta property="article:author" content="harumonia"><meta property="article:tag" content="diyTools"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://harumona-blog.oss-cn-beijing.aliyuncs.com/new_articles/mori.gif"><script>(function() {
  if (CONFIG.mode !== 'auto') return
  const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches
  const setting = localStorage.getItem('darken-mode') || 'auto'
  if (setting === 'dark' || (prefersDark && setting !== 'light'))
    document.documentElement.classList.toggle('dark', true)
})()</script></head><body><script src="https://code.iconify.design/2/2.1.1/iconify.min.js"></script><script>IconifyProviders={"":{resources:["https://api.iconify.design"],rotate:1e3}}</script><script defer src="https://cdn.jsdelivr.net/npm/animejs@latest"></script><script defer src="/js/ui/fireworks.js" type="module"></script><canvas class="fireworks"></canvas><div class="container"><a class="sidebar-toggle hty-icon-button" id="menu-btn"><div class="hamburger hamburger--spin" type="button"><span class="hamburger-box"><span class="hamburger-inner"></span></span></div></a><div class="sidebar-toggle sidebar-overlay"></div><aside class="sidebar"><script src="/js/sidebar.js" type="module"></script><ul class="sidebar-nav"><li class="sidebar-nav-item sidebar-nav-toc hty-icon-button sidebar-nav-active" data-target="post-toc-wrap" title="文章目录"><span class="icon iconify" data-icon="ri:list-ordered"></span></li><li class="sidebar-nav-item sidebar-nav-overview hty-icon-button" data-target="site-overview-wrap" title="站点概览"><span class="icon iconify" data-icon="ri:passport-line"></span></li></ul><div class="sidebar-panel" id="site-overview-wrap"><div class="site-info fix-top"><a class="site-author-avatar" href="/about/" title="harumonia"><img width="96" loading="lazy" src="https://harumona-blog.oss-cn-beijing.aliyuncs.com/blog/Ocabe.webp" alt="harumonia"></a><div class="site-author-name"><a href="/about/">harumonia</a></div><span class="site-name">Zaxon</span><sub class="site-subtitle">Find the key of soul</sub><div class="site-description">lazy</div></div><nav class="site-state"><a class="site-state-item hty-icon-button icon-home" href="/" title="首页"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-home-4-line"></use></svg></span></a><div class="site-state-item"><a href="/archives/" title="归档"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-archive-line"></use></svg></span><span class="site-state-item-count">141</span></a></div><div class="site-state-item"><a href="/categories/" title="分类"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-folder-2-line"></use></svg></span><span class="site-state-item-count">15</span></a></div><div class="site-state-item"><a href="/tags/" title="标签"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="site-state-item-count">71</span></a></div><a class="site-state-item hty-icon-button" href="/bangumis/index.html" title="bangumi"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-book-2-line"></use></svg></span></a></nav><hr style="margin-bottom:.5rem"><div class="links-of-author"><a class="links-of-author-item hty-icon-button" rel="noopener" href="/atom.xml" title="RSS" target="_blank" style="color:orange"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-rss-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://qm.qq.com/cgi-bin/qm/qr?k=DSmoEtSKHITcV9pghYqqmSQ80-SPnPjm&amp;noverify=0" title="QQ" target="_blank" style="color:#12b7f5"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-qq-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://github.com/zxjlm" title="GitHub" target="_blank" style="color:#6e5494"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-github-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://www.douban.com/people/Zxj_Butterfly_m/" title="豆瓣" target="_blank" style="color:#072"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-douban-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://music.163.com/#/user/home?id=305617499" title="网易云音乐" target="_blank" style="color:#c20c0c"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-netease-cloud-music-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://space.bilibili.com/1801214" title="哔哩哔哩" target="_blank" style="color:#ff8eb3"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-bilibili-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://twitter.com/Harumonia1996" title="Twitter" target="_blank" style="color:#1da1f2"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-twitter-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="mailto:zxjlm233@gmail.com" title="E-Mail" target="_blank" style="color:#8e71c1"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-mail-line"></use></svg></a></div><hr style="margin:.5rem 1rem"><div class="links"><a class="links-item hty-icon-button" href="/links/" title="我的小伙伴们" style="color:#1e90ff"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-genderless-line"></use></svg></a></div><br><a class="links-item hty-icon-button" id="toggle-mode-btn" href="javascript:;" title="Mode" style="color:#f1cb64"><span class="icon iconify" data-icon="ri:contrast-2-line"></span></a></div><div class="sidebar-panel sidebar-panel-active" id="post-toc-wrap"><div class="post-toc"><div class="post-toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">2.</span> <span class="toc-text">遇到的问题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B3%E4%BA%8E-requests-%E7%9A%84-hooks"><span class="toc-number">2.1.</span> <span class="toc-text">关于 requests 的 hooks</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BD%BF%E7%94%A8-hooks"><span class="toc-number">2.1.1.</span> <span class="toc-text">为什么使用 hooks</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B3%E4%BA%8E%E8%84%9A%E6%9C%AC%E4%B8%AD%E7%9A%84%E9%87%8D%E8%AF%95"><span class="toc-number">2.2.</span> <span class="toc-text">关于脚本中的重试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#xlwt-%E7%9A%84%E5%88%97%E5%AE%BD%E9%97%AE%E9%A2%98"><span class="toc-number">2.3.</span> <span class="toc-text">xlwt 的列宽问题</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%91%98%E5%87%BA%E5%B8%B8%E7%94%A8%E4%BB%A3%E7%A0%81"><span class="toc-number">3.</span> <span class="toc-text">摘出常用代码</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%82%AE%E4%BB%B6%E5%8F%91%E9%80%81"><span class="toc-number">3.1.</span> <span class="toc-text">邮件发送</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%86%E4%BA%8C%E7%BB%B4%E6%95%B0%E7%BB%84%E5%8F%98%E6%88%90-html-table"><span class="toc-number">3.2.</span> <span class="toc-text">将二维数组变成 html-table</span></a></li></ol></li></ol></div></div></div></aside><main class="sidebar-translate" id="content"><div id="post"><article class="hty-card post-block" itemscope itemtype="https://schema.org/Article" style="--smc-primary:#0078E7"><link itemprop="mainEntityOfPage" href="https://blog.harumonia.moe/mori-question-and-code-collection/"><span hidden itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="name" content="harumonia"><meta itemprop="description"></span><span hidden itemprop="publisher" itemscope itemtype="https://schema.org/Organization"><meta itemprop="name" content="Zaxon"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">Mori Kokoro 开发过程中遇到的问题(2) 以及使用代码收集</h1><div class="post-meta"><div class="post-time"><span class="post-meta-item-icon"><span class="icon iconify" data-icon="ri:calendar-line"></span></span> <time title="创建时间：2020-11-10 10:52:26" itemprop="dateCreated datePublished" datetime="2020-11-10T10:52:26+00:00">2020-11-10</time><span class="post-meta-divider">-</span><span class="post-meta-item-icon"><span class="icon iconify" data-icon="ri:calendar-2-line"></span></span> <time title="修改时间：2020-11-19 17:03:26" itemprop="dateModified" datetime="2020-11-19T17:03:26+00:00">2020-11-19</time></div><div class="post-classify"><span class="post-category"><span class="post-meta-item-icon" style="margin-right:3px"><span class="icon iconify" data-icon="ri:folder-line"></span></span><span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a class="category-item" href="/categories/%E6%BA%90%E6%B5%81%E6%B8%85%E6%B3%89/" style="--text-color:var(--hty-text-color)" itemprop="url" rel="index"><span itemprop="text">源流清泉</span></a></span> > <span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a class="category-item" href="/categories/%E6%BA%90%E6%B5%81%E6%B8%85%E6%B3%89/Python/" style="--text-color:var(--hty-text-color)" itemprop="url" rel="index"><span itemprop="text">Python</span></a></span></span><span class="post-tag"><span class="post-meta-divider">-</span><a class="tag-item" href="/tags/diyTools/" style="--text-color:var(--hty-text-color)"><span class="post-meta-item-icon"><span class="icon iconify" data-icon="ri:price-tag-3-line"></span></span><span class="tag-name">diyTools</span></a></span></div><div class="post-author"><div class="author-avatar"><img src="https://www.gravatar.com/avatar/170126958484dfae0e26934864b36b4e?s=20&amp;d=https%3A%2F%2Fcdn.jsdelivr.net%2Fgh%2FYunYouJun%2Fcdn%2Fimg%2Favatar%2Fnone.jpg"></div><span class="author-name">harumonia</span></div></div></header><section class="post-body" itemprop="articleBody"><div class="post-content markdown-body"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>距离 Mori v0.1 成形已经过了一周.这一周里面对这个代码进行了进一步的优化.</p><p>在 <a href="https://blog.harumonia.moe/mori-kokoro/">Mori Kokoro 开发记录</a> 中已经对上个阶段开发中遇到的问题进行了一次汇总.本篇是对本阶段的问题的汇总.</p><p>另外.将一些实用的代码摘出.并进行注释说明.</p><p><img src="https://harumona-blog.oss-cn-beijing.aliyuncs.com/new_articles/mori.gif" alt="mori" loading="lazy"></p><span id="more"></span><h2 id="遇到的问题"><a href="#遇到的问题" class="headerlink" title="遇到的问题"></a>遇到的问题</h2><h3 id="关于-requests-的-hooks"><a href="#关于-requests-的-hooks" class="headerlink" title="关于 requests 的 hooks"></a>关于 requests 的 hooks</h3><p>Mori 中使用 hook 主要是用来进行时间统计.</p><p>在 requests 的 response 中已经存在的请求时间统计.代码如下.</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># Start time (approximately) of the request</span>
start <span class="token operator">=</span> preferred_clock<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># Send the request</span>
r <span class="token operator">=</span> adapter<span class="token punctuation">.</span>send<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>

<span class="token comment"># Total elapsed time of the request (approximately)</span>
elapsed <span class="token operator">=</span> preferred_clock<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start
r<span class="token punctuation">.</span>elapsed <span class="token operator">=</span> timedelta<span class="token punctuation">(</span>seconds<span class="token operator">=</span>elapsed<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>可以发现.这里仅仅统计了请求所花费的时间.但是我们需要的不仅仅是这个时间.而是从开始处理(包括 post-data 的渲染等)到请求结束的时间.</p><h4 id="为什么使用-hooks"><a href="#为什么使用-hooks" class="headerlink" title="为什么使用 hooks"></a>为什么使用 hooks</h4><p>在 <a target="_blank" rel="noopener" href="https://2.python-requests.org/en/master/user/advanced/#id8">Event Hooks</a> 中.给出将 hooks 应用于 requests.get()以及 Session()两种示例.这两种情况不能一概而论.get()是一次性的.而 Session()是持续的.实际上就是 <em>是否需要对请求的每一个 url 使用 hooks 处理</em> 的这样一个问题.不过文档并没有解决我们的问题–为什么(或者说.什么情况下)使用 hooks?</p><p>而在 StackOverflow 的<a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/17773028/python-requests-hook-or-no-hook">Python Requests: Hook or no Hook?</a>中给出了很具有参考价值的回答.</p><blockquote><p>Hooks should really therefore only be used to drive behaviours that will make things more predictable, not less. For example, Requests uses them internally to handle 401 responses for various kinds of authentication.</p></blockquote><p>同样.在阅读了源码之后.我个人对于 hooks 的用法作出了一些简单的总结.</p><ul><li>仅仅对请求成功的 response 进行处理</li><li>从设计的角度来看.这个处理是隐式的</li><li>可以将 hooks 与 session 绑定.来实现不同情况下的 response 处理</li><li>hooks 如果存在返回值.那么这个返回值将会取代 response &gt; hooks.py line 32~33</li></ul><h3 id="关于脚本中的重试"><a href="#关于脚本中的重试" class="headerlink" title="关于脚本中的重试"></a>关于脚本中的重试</h3><p>这是问题实际上是要在重试次数和高效爬取之间做出一个取舍.</p><p>从实际的情况出发.</p><p>如果在爬虫的代码中.考虑到了网站的不稳定性.从而进行了多段重试.那么.在 api 的检测中最好也要进行多段的重试.否则就会出现爬虫获取到了数据.但是检测脚本报 api 失效的情况.当然.这种情况是概率性的.如果服务端不稳定.那么无论如何增加重试次数.都会有不一致的情况出现.</p><p>而如果代码中就没有进行重试.那么脚本的重试就显得画蛇添足了.</p><h3 id="xlwt-的列宽问题"><a href="#xlwt-的列宽问题" class="headerlink" title="xlwt 的列宽问题"></a>xlwt 的列宽问题</h3><p>这里的列宽与在 excel 右击 column 所显示的列宽不同.</p><p>在<a target="_blank" rel="noopener" href="https://buxty.com/b/2011/10/widths-heights-with-xlwt-python/">Widths &amp; Heights with xlwt + Python</a> 找到了解答.</p><blockquote><p>Columns have a property for setting the width. The value is an integer specifying the size measured in 1/256 of the width of the character ‘0’ as it appears in the sheet’s default font. xlwt creates columns with a default width of 2962, roughly equivalent to 11 characters wide.</p></blockquote><p>也就是说：xlwt 中列宽的值表示方法：默认字体 ‘0’ 的 1/256 为衡量单位.默认宽度值是 2960.大约是 11 个字符的宽度.</p><p>在实际的使用中.我是用的是 256*40+180 这种计算方法.得到的更接近于 40 个字符的宽度.</p><h2 id="摘出常用代码"><a href="#摘出常用代码" class="headerlink" title="摘出常用代码"></a>摘出常用代码</h2><h3 id="邮件发送"><a href="#邮件发送" class="headerlink" title="邮件发送"></a>邮件发送</h3><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">send_mail</span><span class="token punctuation">(</span>receivers<span class="token punctuation">:</span> <span class="token builtin">list</span><span class="token punctuation">,</span> file_content<span class="token punctuation">,</span> html<span class="token punctuation">,</span> subject<span class="token punctuation">,</span> mail_host<span class="token punctuation">,</span> mail_user<span class="token punctuation">,</span> mail_pass<span class="token punctuation">,</span> mail_port<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    发送邮件
    配置信息见README
    """</span>
    <span class="token keyword">import</span> smtplib
    <span class="token keyword">from</span> email<span class="token punctuation">.</span>mime<span class="token punctuation">.</span>text <span class="token keyword">import</span> MIMEText
    <span class="token keyword">from</span> email<span class="token punctuation">.</span>mime<span class="token punctuation">.</span>multipart <span class="token keyword">import</span> MIMEMultipart

    sender <span class="token operator">=</span> mail_user
    message <span class="token operator">=</span> MIMEMultipart<span class="token punctuation">(</span><span class="token punctuation">)</span>
    message<span class="token punctuation">[</span><span class="token string">'From'</span><span class="token punctuation">]</span> <span class="token operator">=</span> sender
    message<span class="token punctuation">[</span><span class="token string">'To'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">';'</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>receivers<span class="token punctuation">)</span>
    message<span class="token punctuation">[</span><span class="token string">'Subject'</span><span class="token punctuation">]</span> <span class="token operator">=</span> subject

    <span class="token keyword">if</span> html<span class="token punctuation">:</span>
        message<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>MIMEText<span class="token punctuation">(</span>html<span class="token punctuation">,</span> <span class="token string">'html'</span><span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    part <span class="token operator">=</span> MIMEText<span class="token punctuation">(</span>file_content<span class="token punctuation">.</span>getvalue<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"vnd.ms-excel"</span><span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span>
    part<span class="token punctuation">.</span>add_header<span class="token punctuation">(</span><span class="token string">'Content-Disposition'</span><span class="token punctuation">,</span> <span class="token string">'attachment'</span><span class="token punctuation">,</span>
                    filename<span class="token operator">=</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">&#123;</span>subject<span class="token punctuation">&#125;</span></span><span class="token string">.xls'</span></span><span class="token punctuation">)</span>
    message<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>part<span class="token punctuation">)</span>

    <span class="token keyword">for</span> count <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> mail_port <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
                smtp <span class="token operator">=</span> smtplib<span class="token punctuation">.</span>SMTP<span class="token punctuation">(</span><span class="token punctuation">)</span>
                smtp<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>mail_host<span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                smtp <span class="token operator">=</span> smtplib<span class="token punctuation">.</span>SMTP_SSL<span class="token punctuation">(</span>mail_host<span class="token punctuation">,</span> mail_port<span class="token punctuation">)</span>
            smtp<span class="token punctuation">.</span>ehlo<span class="token punctuation">(</span><span class="token punctuation">)</span>
            smtp<span class="token punctuation">.</span>login<span class="token punctuation">(</span>mail_user<span class="token punctuation">,</span> mail_pass<span class="token punctuation">)</span>
            smtp<span class="token punctuation">.</span>sendmail<span class="token punctuation">(</span>sender<span class="token punctuation">,</span> receivers<span class="token punctuation">,</span> message<span class="token punctuation">.</span>as_string<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            smtp<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">break</span>
        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> _e<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>_e<span class="token punctuation">)</span>
            <span class="token keyword">if</span> count <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">:</span>
                <span class="token keyword">raise</span> Exception<span class="token punctuation">(</span><span class="token string">'failed to send email'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="将二维数组变成-html-table"><a href="#将二维数组变成-html-table" class="headerlink" title="将二维数组变成 html-table"></a>将二维数组变成 html-table</h3><p>在发送邮件时.邮件的内容可以是 html.所以将报表的结果变为 html-table.更方便查看.</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">generate_table</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
    th <span class="token operator">=</span> <span class="token string">''</span>
    <span class="token keyword">for</span> value <span class="token keyword">in</span> self<span class="token punctuation">.</span>headers<span class="token punctuation">:</span>
        th <span class="token operator">+=</span> <span class="token string-interpolation"><span class="token string">f'&lt;th style="border:1px solid"></span><span class="token interpolation"><span class="token punctuation">&#123;</span>value<span class="token punctuation">&#125;</span></span><span class="token string">&lt;/th>'</span></span>
    thead <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f'&lt;thead style="background-color:gray;"></span><span class="token interpolation"><span class="token punctuation">&#123;</span>th<span class="token punctuation">&#125;</span></span><span class="token string">&lt;/thead>'</span></span> <span class="token comment"># 表头的底色变为灰色</span>
    tbody <span class="token operator">=</span> <span class="token string">''</span>
    <span class="token keyword">for</span> result <span class="token keyword">in</span> self<span class="token punctuation">.</span>results<span class="token punctuation">:</span>
        tr <span class="token operator">=</span> <span class="token string">''</span>
        <span class="token keyword">for</span> header <span class="token keyword">in</span> self<span class="token punctuation">.</span>headers<span class="token punctuation">:</span>
            tr <span class="token operator">+=</span> <span class="token string-interpolation"><span class="token string">f'&lt;td style="border:1px solid"></span><span class="token interpolation"><span class="token punctuation">&#123;</span>result<span class="token punctuation">[</span>header<span class="token punctuation">]</span><span class="token punctuation">&#125;</span></span><span class="token string">&lt;/td>'</span></span>
        <span class="token keyword">if</span> result<span class="token punctuation">[</span><span class="token string">'check_result'</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">"OK"</span><span class="token punctuation">:</span>    <span class="token comment"># 判断结果是否是'OK',如果不是,则该行变为红色</span>
            tbody <span class="token operator">+=</span> <span class="token string-interpolation"><span class="token string">f'&lt;tr style="color:red"></span><span class="token interpolation"><span class="token punctuation">&#123;</span>tr<span class="token punctuation">&#125;</span></span><span class="token string">&lt;/tr>'</span></span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            tbody <span class="token operator">+=</span> <span class="token string-interpolation"><span class="token string">f'&lt;tr></span><span class="token interpolation"><span class="token punctuation">&#123;</span>tr<span class="token punctuation">&#125;</span></span><span class="token string">&lt;/tr>'</span></span>
    <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f'&lt;p>Mori Result&lt;/p>&lt;table style="border:1px solid"></span><span class="token interpolation"><span class="token punctuation">&#123;</span>thead<span class="token punctuation">&#125;</span></span><span class="token interpolation"><span class="token punctuation">&#123;</span>tbody<span class="token punctuation">&#125;</span></span><span class="token string">&lt;/table>'</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></section><div id="reward-container"><span class="hty-icon-button button-glow" id="reward-button" title="打赏" onclick="var qr = document.getElementById(&quot;qr&quot;); qr.style.display = (qr.style.display === &quot;none&quot;) ? &quot;block&quot; : &quot;none&quot;;"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-hand-coin-line"></use></svg></span><div id="reward-comment">I'm so cute. Please give me money.</div><div id="qr" style="display:none"><div style="display:inline-block"><a target="_blank" rel="noopener" href="https://harumona-blog.oss-cn-beijing.aliyuncs.com/blog/IMG_3741.JPG"><img loading="lazy" src="https://harumona-blog.oss-cn-beijing.aliyuncs.com/blog/IMG_3741.JPG" alt="支付宝" title="支付宝"></a><div><span style="color:#00a3ee"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-alipay-line"></use></svg></span></div></div><div style="display:inline-block"></div><div style="display:inline-block"><a target="_blank" rel="noopener" href="https://harumona-blog.oss-cn-beijing.aliyuncs.com/blog/IMG_3742.JPG"><img loading="lazy" src="https://harumona-blog.oss-cn-beijing.aliyuncs.com/blog/IMG_3742.JPG" alt="微信支付" title="微信支付"></a><div><span style="color:#2dc100"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-wechat-pay-line"></use></svg></span></div></div></div></div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者：</strong>harumonia</li><li class="post-copyright-link"><strong>本文链接：</strong><a href="https://blog.harumonia.moe/mori-question-and-code-collection/" title="Mori Kokoro 开发过程中遇到的问题(2) 以及使用代码收集">https://blog.harumonia.moe/mori-question-and-code-collection/</a></li><li class="post-copyright-license"><strong>版权声明：</strong>本博客所有文章除特别声明外，均默认采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener" title="CC BY-NC-SA 4.0 "><span class="icon iconify" data-icon="ri:creative-commons-line"></span><span class="icon iconify" data-icon="ri:creative-commons-by-line"></span><span class="icon iconify" data-icon="ri:creative-commons-nc-line"></span><span class="icon iconify" data-icon="ri:creative-commons-sa-line"></span></a> 许可协议。</li></ul></article><div class="post-nav"><div class="post-nav-item"><a class="post-nav-prev" href="/learn-awk-1/" rel="prev" title="awk 学习记录"><span class="icon iconify" data-icon="ri:arrow-left-s-line"></span><span class="post-nav-text">awk 学习记录</span></a></div><div class="post-nav-item"><a class="post-nav-next" href="/mori-kokoro/" rel="next" title="Mori Kokoro 开发记录"><span class="post-nav-text">Mori Kokoro 开发记录</span><span class="icon iconify" data-icon="ri:arrow-right-s-line"></span></a></div></div></div><div class="hty-card" id="comment"></div></main><footer class="sidebar-translate" id="footer"><div class="copyright"><span>&copy; 2018 – 2026 </span><span class="with-love" id="animate"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-cloud-line"></use></svg></span><span class="author">harumonia</span></div><div class="live-time"><span>本博客已萌萌哒地运行</span><span id="display_live_time"></span><span class="moe-text">(●'◡'●)</span><script>function blog_live_time() {
  setTimeout(blog_live_time, 1000);
  const start = new Date('2018-10-25T00:00:00');
  const now = new Date();
  const timeDiff = (now.getTime() - start.getTime());
  const msPerMinute = 60 * 1000;
  const msPerHour = 60 * msPerMinute;
  const msPerDay = 24 * msPerHour;
  const passDay = Math.floor(timeDiff / msPerDay);
  const passHour = Math.floor((timeDiff % msPerDay) / 60 / 60 / 1000);
  const passMinute = Math.floor((timeDiff % msPerHour) / 60 / 1000);
  const passSecond = Math.floor((timeDiff % msPerMinute) / 1000);
  display_live_time.innerHTML = ` ${passDay} 天 ${passHour} 小时 ${passMinute} 分 ${passSecond} 秒`;
}
blog_live_time();</script></div></footer></div><a class="hty-icon-button" id="back-to-top" aria-label="back-to-top" href="#"><span class="icon iconify" data-icon="ri:arrow-up-s-line"></span><svg class="progress-circle-container" viewBox="0 0 100 100"><circle class="progress-circle" id="progressCircle" cx="50" cy="50" r="48" fill="none" stroke="#0078E7" stroke-width="2" stroke-linecap="round"></circle></svg></a><a class="popup-trigger hty-icon-button icon-search" id="search" target="_blank" rel="noopener" href="https://www.google.com/search?q=site:harumonia.moe" title="搜索"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:search-line"></span></span></a></body></html>