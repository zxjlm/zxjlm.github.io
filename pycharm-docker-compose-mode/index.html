<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="theme-color" content="#0078E7"><meta name="author" content="harumonia"><meta name="copyright" content="harumonia"><meta name="generator" content="Hexo 5.1.1"><meta name="theme" content="hexo-theme-yun"><title>Pycharm 和 VSCode 的 docker compose 开发模式 | Zaxon</title><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@900&amp;display=swap" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/star-markdown-css@0.1.25/dist/yun/yun-markdown.min.css"><script src="//at.alicdn.com/t/font_1140697_j5gk85dg4pf.js" async></script><script src="https://cdn.jsdelivr.net/npm/scrollreveal/dist/scrollreveal.min.js" defer></script><script>document.addEventListener("DOMContentLoaded", () => {
  [".post-card",".post-content img"].forEach((target)=> {
    ScrollReveal().reveal(target);
  })
});</script><link id="light-prism-css" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@latest/themes/prism.css" media="(prefers-color-scheme:light)"><link id="dark-prism-css" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@latest/themes/prism-tomorrow.css" media="(prefers-color-scheme:dark)"><link rel="icon" href="/yun.svg"><link rel="mask-icon" href="/yun.svg" color="#0078E7"><link rel="alternate icon" href="/yun.ico"><link rel="preload" href="/css/hexo-theme-yun.css" as="style"><link rel="preload" href="/js/utils.js" as="script"><link rel="preload" href="/js/hexo-theme-yun.js" as="script"><link rel="prefetch" href="/js/sidebar.js" as="script"><link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin><script id="yun-config">const Yun = window.Yun || {};
    window.CONFIG = {"hostname":"blog.harumonia.moe","root":"/","title":"Zaxon-迷雾中的藏宝地","version":"1.6.1","mode":"auto","copycode":true,"page":{"isPost":true},"i18n":{"placeholder":"搜索...","empty":"找不到您查询的内容: ${query}","hits":"找到 ${hits} 条结果","hits_time":"找到 ${hits} 条结果（用时 ${time} 毫秒）"},"anonymous_image":"https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/avatar/none.jpg","say":{"api":"https://v1.hitokoto.cn","hitokoto":true},"fireworks":{"colors":["102, 167, 221","62, 131, 225","33, 78, 194"]}};</script><link rel="stylesheet" href="/css/hexo-theme-yun.css"><script src="/js/utils.js"></script><script src="/js/hexo-theme-yun.js"></script><link rel="preconnect" href="https://www.google-analytics.com" crossorigin><script async src="https://www.googletagmanager.com/gtag/js?id=G-EBNGE3F0F6"></script><script>function gtag(){dataLayer.push(arguments)}CONFIG.hostname===location.hostname&&(window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-EBNGE3F0F6"))</script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><meta name="description" content="本篇是关于如何在 Pycharm 和 VSCode 中使用 Docker Compose 的. 开篇比较啰嗦, 大抵是踩过的一些坑和问题的解决过程, 实际的配置内容自 转 这一节开始."><meta property="og:type" content="article"><meta property="og:title" content="Pycharm 和 VSCode 的 docker compose 开发模式"><meta property="og:url" content="https://blog.harumonia.moe/pycharm-docker-compose-mode/index.html"><meta property="og:site_name" content="Zaxon"><meta property="og:description" content="本篇是关于如何在 Pycharm 和 VSCode 中使用 Docker Compose 的. 开篇比较啰嗦, 大抵是踩过的一些坑和问题的解决过程, 实际的配置内容自 转 这一节开始."><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://raw.githubusercontent.com/zxjlm/my-static-files/main/img/docker%E7%A9%BA%E8%BD%BD.png"><meta property="og:image" content="https://raw.githubusercontent.com/zxjlm/my-static-files/main/img/docker-attach-django.png"><meta property="og:image" content="https://raw.githubusercontent.com/zxjlm/my-static-files/main/img/pycharm-compose.png"><meta property="article:published_time" content="2022-05-28T17:53:00.000Z"><meta property="article:modified_time" content="2022-07-17T13:20:12.500Z"><meta property="article:author" content="harumonia"><meta property="article:tag" content="Python"><meta property="article:tag" content="Docker"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://raw.githubusercontent.com/zxjlm/my-static-files/main/img/docker%E7%A9%BA%E8%BD%BD.png"><script src="/js/ui/mode.js"></script></head><body><script defer src="https://cdn.jsdelivr.net/npm/animejs@latest"></script><script defer src="/js/ui/fireworks.js"></script><canvas class="fireworks"></canvas><div class="container"><a class="sidebar-toggle hty-icon-button" id="menu-btn"><div class="hamburger hamburger--spin" type="button"><span class="hamburger-box"><span class="hamburger-inner"></span></span></div></a><div class="sidebar-toggle sidebar-overlay"></div><aside class="sidebar"><script src="/js/sidebar.js"></script><ul class="sidebar-nav"><li class="sidebar-nav-item sidebar-nav-toc hty-icon-button sidebar-nav-active" data-target="post-toc-wrap" title="文章目录"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-list-ordered"></use></svg></li><li class="sidebar-nav-item sidebar-nav-overview hty-icon-button" data-target="site-overview-wrap" title="站点概览"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-passport-line"></use></svg></li></ul><div class="sidebar-panel" id="site-overview-wrap"><div class="site-info fix-top"><a class="site-author-avatar" href="/about/" title="harumonia"><img width="96" loading="lazy" src="https://harumona-blog.oss-cn-beijing.aliyuncs.com/blog/Ocabe.webp" alt="harumonia"></a><div class="site-author-name"><a href="/about/">harumonia</a></div><span class="site-name">Zaxon</span><sub class="site-subtitle">Find the key of soul</sub><div class="site-desciption">lazy</div></div><nav class="site-state"><a class="site-state-item hty-icon-button icon-home" href="/" title="首页"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-home-4-line"></use></svg></span></a><div class="site-state-item"><a href="/archives/" title="归档"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-archive-line"></use></svg></span><span class="site-state-item-count">131</span></a></div><div class="site-state-item"><a href="/categories/" title="分类"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-folder-2-line"></use></svg></span><span class="site-state-item-count">16</span></a></div><div class="site-state-item"><a href="/tags/" title="标签"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="site-state-item-count">71</span></a></div><a class="site-state-item hty-icon-button" href="/books" title="读书"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-book-2-line"></use></svg></span></a></nav><hr style="margin-bottom:.5rem"><div class="links-of-author"><a class="links-of-author-item hty-icon-button" rel="noopener" href="/atom.xml" title="RSS" target="_blank" style="color:orange"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-rss-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://qm.qq.com/cgi-bin/qm/qr?k=DSmoEtSKHITcV9pghYqqmSQ80-SPnPjm&amp;noverify=0" title="QQ" target="_blank" style="color:#12b7f5"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-qq-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://github.com/zxjlm" title="GitHub" target="_blank" style="color:#6e5494"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-github-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://www.douban.com/people/Zxj_Butterfly_m/" title="豆瓣" target="_blank" style="color:#072"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-douban-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://music.163.com/#/user/home?id=305617499" title="网易云音乐" target="_blank" style="color:#c20c0c"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-netease-cloud-music-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://space.bilibili.com/1801214" title="哔哩哔哩" target="_blank" style="color:#ff8eb3"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-bilibili-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://twitter.com/Harumonia1996" title="Twitter" target="_blank" style="color:#1da1f2"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-twitter-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="mailto:zxjlm233@gmail.com" title="E-Mail" target="_blank" style="color:#8e71c1"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-mail-line"></use></svg></a></div><hr style="margin:.5rem 1rem"><div class="links"><a class="links-item hty-icon-button" href="/links/" title="我的小伙伴们" style="color:#1e90ff"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-genderless-line"></use></svg></a></div><br><a class="links-item hty-icon-button" id="toggle-mode-btn" href="javascript:;" title="Mode" style="color:#f1cb64"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-contrast-2-line"></use></svg></a></div><div class="sidebar-panel sidebar-panel-active" id="post-toc-wrap"><div class="post-toc"><div class="post-toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B5%B7"><span class="toc-number">1.</span> <span class="toc-text">起</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%BF"><span class="toc-number">2.</span> <span class="toc-text">承</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#VSCode-%E4%B8%AD%E7%9A%84%E5%BC%80%E5%8F%91%E6%A8%A1%E5%BC%8F"><span class="toc-number">2.1.</span> <span class="toc-text">VSCode 中的开发模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%A8-PyCharm-%E4%B8%AD%E5%A4%8D%E5%88%BB"><span class="toc-number">2.2.</span> <span class="toc-text">在 PyCharm 中复刻?</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BD%AC"><span class="toc-number">3.</span> <span class="toc-text">转</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#20220604%E5%86%85%E5%AE%B9%E5%A2%9E%E8%A1%A5"><span class="toc-number">3.1.</span> <span class="toc-text">20220604内容增补</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%88"><span class="toc-number">4.</span> <span class="toc-text">合</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E-docker-compose-%E7%9A%84%E5%BC%80%E5%8F%91%E7%AD%96%E7%95%A5"><span class="toc-number">4.1.</span> <span class="toc-text">基于 docker compose 的开发策略</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Docker-%E5%9C%A8%E5%BC%80%E5%8F%91%E4%B8%AD%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-number">4.2.</span> <span class="toc-text">Docker 在开发中的使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%A7%E8%83%BD%E6%AF%94%E8%BE%83"><span class="toc-number">4.3.</span> <span class="toc-text">性能比较</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#vscode"><span class="toc-number">4.3.1.</span> <span class="toc-text">vscode</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#pycharm"><span class="toc-number">4.3.2.</span> <span class="toc-text">pycharm</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Reference"><span class="toc-number">5.</span> <span class="toc-text">Reference</span></a></li></ol></div></div></div></aside><main class="sidebar-translate" id="content"><div id="post"><article class="hty-card post-block" itemscope itemtype="https://schema.org/Article"><link itemprop="mainEntityOfPage" href="https://blog.harumonia.moe/pycharm-docker-compose-mode/"><span hidden itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="name" content="harumonia"><meta itemprop="description"></span><span hidden itemprop="publisher" itemscope itemtype="https://schema.org/Organization"><meta itemprop="name" content="Zaxon"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">Pycharm 和 VSCode 的 docker compose 开发模式</h1><div class="post-meta"><div class="post-time" style="display:inline-block"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-calendar-line"></use></svg></span><time title="创建时间：2022-05-28 17:53:00" itemprop="dateCreated datePublished" datetime="2022-05-28T17:53:00+00:00">2022-05-28</time><span class="post-meta-divider">-</span><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-calendar-2-line"></use></svg></span><time title="修改时间：2022-07-17 13:20:12" itemprop="dateModified" datetime="2022-07-17T13:20:12+00:00">2022-07-17</time></div><div class="post-classify"><span class="post-category"><span class="post-meta-item-icon" style="margin-right:3px"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-folder-line"></use></svg></span><span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a class="category-item" href="/categories/%E6%BA%90%E6%B5%81%E6%B8%85%E6%B3%89/" style="--text-color:var(--hty-text-color)" itemprop="url" rel="index"><span itemprop="text">源流清泉</span></a></span> > <span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a class="category-item" href="/categories/%E6%BA%90%E6%B5%81%E6%B8%85%E6%B3%89/Python/" style="--text-color:var(--hty-text-color)" itemprop="url" rel="index"><span itemprop="text">Python</span></a></span></span><span class="post-tag"><span class="post-meta-divider">-</span><a class="tag-item" href="/tags/Python/" style="--text-color:#3776ab"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="tag-name">Python</span></a><a class="tag-item" href="/tags/Docker/" style="--text-color:var(--hty-text-color)"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="tag-name">Docker</span></a></span></div><div class="post-author"><div class="author-avatar"><img src="https://www.gravatar.com/avatar/170126958484dfae0e26934864b36b4e?s=20&amp;d=https%3A%2F%2Fcdn.jsdelivr.net%2Fgh%2FYunYouJun%2Fcdn%2Fimg%2Favatar%2Fnone.jpg"></div><span class="author-name">harumonia</span></div></div></header><section class="post-body" itemprop="articleBody"><div class="post-content markdown-body" style="--smc-primary:#0078E7"><p>本篇是关于如何在 Pycharm 和 VSCode 中使用 Docker Compose 的. 开篇比较啰嗦, 大抵是踩过的一些坑和问题的解决过程, 实际的配置内容自 <a href="#%E8%BD%AC">转</a> 这一节开始.</p><a id="more"></a><h2 id="起"><a href="#起" class="headerlink" title="起"></a>起</h2><p>公司的项目是通过 <code>docker compose</code> 进行管理, 包含 nginx \ sql \ backend 等几个部分, 后端开发的时候, 主要关注的是 backend 服务.</p><p>backend 具有如下的一个目录结构, 在开发时, 通用的一个方法是使用 <code>docker compose up -d</code> 开启集群服务, 然后使用 <code>vscode</code> 的 docker 相关的插件, <code>attach</code> 到对应的服务中, 进行开发. 由于使用了 -v 挂载目录, 所以不需要担心修改内容丢失的问题.</p><pre class="line-numbers language-text" data-language="text"><code class="language-text">├── django_www
    ├── ...
    ├── manage.py
    ├── poetry.lock
    ├── poetry.toml
    ├── pyproject.toml
    └── pytest.ini
├── docker-compose.yml
├── frontend
├── Dockerfile
└── ...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>笔者算是第一次用 vscode 进行项目级别的后端开发, 在配置玩 python 的各种插件之后, 终于是完成了 <strong>文本编辑器</strong> 到 ___IDE__ 的蜕变.</p><p>不过作为一个3年 pycharm 用户, 闲暇之余, 自然是比较好奇项目在TL口中”比较麻烦”的 pycharm 是个什么样子.</p><h2 id="承"><a href="#承" class="headerlink" title="承"></a>承</h2><h3 id="VSCode-中的开发模式"><a href="#VSCode-中的开发模式" class="headerlink" title="VSCode 中的开发模式"></a>VSCode 中的开发模式</h3><p>想要在 PyCharm 中实现 docker compose dev , 最好是能够先了解这样的开发模式在 vscode 运作的核心流程 \ 原理.</p><p>在 VSCode 中选择 <strong>attach to a running container</strong> 之后, 首先会看到编辑器提示 <strong>start dev container…</strong>, 随后, 容器中会安装(如果是第一次 attach )并启动一系列的 <code>vscode-server</code> 进程. 这实际上与之前使用 <code>ssh</code> 连接远程服务器 (remote-server) 进行开发的过程是差不多的. (当然, 从命令的角度来看, attach 与 ssh 存在本质上的区别, exec 更加接进 ssh)</p><p>于是, 可以总结出基于 vscode 的开发流程如下:</p><ol><li>attach 到运行中的项目容器</li><li>安装 vscode-server &amp;&amp; 安装 vscode-extensions</li><li>完成开发的前置工作.</li></ol><h3 id="在-PyCharm-中复刻"><a href="#在-PyCharm-中复刻" class="headerlink" title="在 PyCharm 中复刻?"></a>在 PyCharm 中复刻?</h3><p>pycharm 在官方文档中有 <a target="_blank" rel="noopener" href="https://www.jetbrains.com/help/pycharm/using-docker-compose-as-a-remote-interpreter.html#summary">docker-compose</a> 这样一篇配置教程. 按照这个流程走完之后, 就可以在pycharm中运行一个 demo 级的 docker-compose 结构的项目.</p><p>但是项目的运行却出现了问题. 项目的依赖使用 poetry 进行管理, Dockerfile 中只存在 <code>poetry install --no-dev</code> 这样的依赖安装流程, 这是因为这样的安装不会牵扯进 <em>开发级别</em> 的依赖, 如 <code>pytest</code> \ <code>mypy</code> 等ci相关的依赖. 所以在开发的时候, 还需要在容器中执行 <code>poetry install</code> 或者 <code>poetry update</code> 来将缺失的开发依赖加进来.</p><p>这样就引出了我们遇到的问题, container 一旦重启, 那就 <strong>需要重新执行一遍安装命令</strong> , 当开发依赖很多时, 这个过程就很痛苦了. 使用 <code>vscode -&gt; attach docker container</code> 的方法, 我们可以保证在不重启容器的情况下完成开发. 但是对于 pycharm 来说, 每一次启动, 都会对容器进行重建, 那我们之前安装的东西就全清空了.</p><p>自然地, 笔者开始寻找 pycharm 中有没有不重建容器的办法, 因为在 django 的运行配置中, 有 <code>docker compose</code> 一栏, 能够配置相关的命令和参数, 但是这里只能配置pycharm支持的命令和参数, <code>docker compose up --no-recreate</code> 之类的命令恰好是<a target="_blank" rel="noopener" href="https://youtrack.jetbrains.com/issue/PY-47305">不被支持</a>的.</p><p><code>inspect</code> 到 pycharm 创建的容器中, 可以发现, 它并没有按照 <code>docker-compose.yaml</code> 文件中的 <code>command</code> 执行, 而是启动了如下的命令.</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token property">"Args"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token string">"-u"</span><span class="token punctuation">,</span>
            <span class="token string">"/opt/.pycharm_helpers/pydev/pydevd.py"</span><span class="token punctuation">,</span>
            <span class="token string">"--multiprocess"</span><span class="token punctuation">,</span>
            <span class="token string">"--qt-support=auto"</span><span class="token punctuation">,</span>
            <span class="token string">"--port"</span><span class="token punctuation">,</span>
            <span class="token string">"56286"</span><span class="token punctuation">,</span>
            <span class="token string">"--file"</span><span class="token punctuation">,</span>
            <span class="token string">"/var/www/src/django_www/manage.py"</span><span class="token punctuation">,</span>
            <span class="token string">"runserver"</span><span class="token punctuation">,</span>
            <span class="token string">"0.0.0.0:3001"</span>
        <span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>看来是 pycharm 用自带的命令组替换了我们之前用来锚定容器的 <code>tail</code> 命令. 再更深一步地看一下, PyCharm是怎样实现这种 <code>cmd</code> 替换的?</p><p>监控 PyCharm 的运行过程, 捕获到如下的指令:</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">/usr/local/bin/docker-compose -f /Users/xinjian.zhang/Projects/Garena/WebSZ/kop-event/shipdoom.kop.kingdomofpirate.com/src/docker-compose.dev.yml -f /Users/xinjian.zhang/Library/Caches/JetBrains/PyCharm2022.1/tmp/docker-compose.override.890.yml up --exit-code-from web --abort-on-container-exit web<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>结合 <a target="_blank" rel="noopener" href="https://docs.docker.com/compose/extends/">官方文档中关于 multi file</a> 的说明, 得到 PyCharm 在 compose 中的 Debug 运行过程.</p><ol><li>使用自带的 override.yml 来追加 \ 覆盖原有的构建文件.</li><li>在 container 中开启一个调试器 (pydev debugger)</li><li>attach 到 container 中, 并连接 (connect) 上调试器</li></ol><p>到此, 基本上可以确定, 无法在 PyCharm 中复刻 vscode 的 <code>attach</code> 开发模式. 不过正如前文所说, vscode 的 <code>attach</code> 实际上是 <code>ssh</code> 的变种, 对于 PyCharm 来说, 实现 ssh remote 开发是完全没有问题的. 不过笔者并没有在 <code>ssh</code> 的路上继续走下去.</p><h2 id="转"><a href="#转" class="headerlink" title="转"></a>转</h2><p>总结一下目前的困境的成因, 主要还是每次启动程序都会 recreate 容器, 而更上一层的原因则是, <strong>开发环境与生产环境的割裂</strong> , 导致我们需要在生产环境的docker中, 将环境更新为开发环境. 那何不一开始就搭建一个开发环境呢? 这样任他重建多少次, 我都不需要在对容器环境上下其手, 开箱即用便是.</p><p>于是笔者对项目的目录结构稍作修改.</p><pre class="line-numbers language-text" data-language="text"><code class="language-text">├── django_www
    ├── ...
    ├── manage.py
    ├── poetry.lock
    ├── poetry.toml
    ├── pyproject.toml
    └── pytest.ini
├── docker-compose.yml
├── docker-compose.dev.yml
├── frontend
├── Dockerfile
├── dev.Dockerfile
└── ...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>然后在安装的时候再加入了一些小trick.</p><ol><li><p>生产环境使用的是私有源, 开发环境下这个源下载速度较慢.<br>包含两种源, 分别是python和linux的源.<br>解决python的源需要修改 poetry 的配置文件, 也就是 pyproject.toml 和 poetry.lock, 但是这两个文件是无法通过上述的方法去copy一个替代品的, 所以在安装的时候, 使用 <code>sed</code> 命令将其中的私有源替换为加速源.<br>解决linux源的问题与python的方法无二, 修改 source.list 文件.</p></li><li><p>对于 pure(slim\apline) 镜像, 先将常用的软件安装齐备.<br>生产环境的镜像为了瘦身, 往往会将很多软件剪除, 但是开发环境需要这些常用的工具用来调试与监测, 如 <code>ping</code> \ <code>top</code> \ <code>vim</code> 等.</p></li><li><p>使用 override config 来升格 docker-compose.dev.yml.<br>Docker Compose 是支持在构建时使用两份 yml 文件的, 详见 <a target="_blank" rel="noopener" href="https://docs.docker.com/compose/extends/">Share Compose configurations between files and projects</a>, 所以我们可以将 dev 环境的 compose 作为一个 override 配置来使用, 从而避免污染项目目录.</p></li></ol><h3 id="20220604内容增补"><a href="#20220604内容增补" class="headerlink" title="20220604内容增补"></a>20220604内容增补</h3><p>上述目录结构中的 <code>dev.Dockerfile</code> 文件其实也并非必要, 在 <a target="_blank" rel="noopener" href="https://docs.docker.com/compose/compose-file/compose-versioning/#version-34">docker compose 3.4</a> 的版本更新中加入了 <strong>target</strong> 参数, 用来指定构建 <em>Dockerfile</em> 中的哪一个区块, 至此, <em>prod</em> 和 <em>dev</em> 的构建指令就可以合并到一份文件中了.</p><h2 id="合"><a href="#合" class="headerlink" title="合"></a>合</h2><p>至此, 对 <strong>pycharm 运行 docker-compose 下的 django</strong> 的探索告一段落. 不过过程中产生的一些疑惑与问题还需要更多的深入研究来解开.</p><h3 id="基于-docker-compose-的开发策略"><a href="#基于-docker-compose-的开发策略" class="headerlink" title="基于 docker compose 的开发策略"></a>基于 docker compose 的开发策略</h3><p>看起来, 如果纠结于使用 pycharm 的话, 在项目的结构上就有了比较严格的约束. 那么这到底是是 docker 的开发模式的问题, 还是 pycharm 的设计问题呢?</p><p>在详细地查阅了相关的文档之后发现, vscode 的其实提供了 <a target="_blank" rel="noopener" href="https://code.visualstudio.com/docs/remote/containers#_working-with-containers">两种基于 contaniner 的开发方案</a>. 其中, <a target="_blank" rel="noopener" href="https://code.visualstudio.com/docs/remote/create-dev-container#_use-docker-compose">使用 docker-compose</a> 的开发方案中提供了详尽的外装开发模式的配置策略. 基于这个文档策略, 甚至可以对 PyCharm 文档中给出的 compose 开发方案进行进一步的优化… (不愧是宇宙第一开发工具😰)</p><p>vscode 所提供的两种配置, 目前看来都是基于 attach 的, 所以在性能上应该差距不大, 只不过配置 devcontainer 可以避免直接 attach 造成的 <em>重建</em> 相关的问题.</p><h3 id="Docker-在开发中的使用"><a href="#Docker-在开发中的使用" class="headerlink" title="Docker 在开发中的使用"></a>Docker 在开发中的使用</h3><p>基于 docker compose 的开发方案究竟是掣肘还是利器?</p><p>摆脱docker进行开发? — 我在doccano的二次开发中进行了这样的尝试.</p><h3 id="性能比较"><a href="#性能比较" class="headerlink" title="性能比较"></a>性能比较</h3><blockquote><p>以下的负载统计均为程序运行一段时间后趋于稳定的负载信息. 即使如此, 以下的统计依然过于粗略, 看个乐呵就行.</p></blockquote><p>总的来说, pycharm 看上去容器的负载会比 vscode 低一些, 不过推测是 IDE 将一部分插件的功能转嫁到程序本身, 而编辑器则是将这部份损耗通过 vscode-server 一并附加到了容器中.</p><h4 id="vscode"><a href="#vscode" class="headerlink" title="vscode"></a>vscode</h4><p><img src="https://raw.githubusercontent.com/zxjlm/my-static-files/main/img/docker%E7%A9%BA%E8%BD%BD.png" alt="docker 空载" loading="lazy"></p><p>图片解释: 由于预先安装了 vscode-server, 所以会存在部分 vscode 相关的程序.</p><p>server 端的 vscode 中安装的插件如下:</p><ul><li>batisteo.vscode-django-1.10.0</li><li>ms-python.python-2022.6.2</li><li>ms-python.vscode-pylance-2022.5.3</li><li>ms-toolsai.jupyter-2022.4.1021342353</li><li>ms-toolsai.jupyter-keymap-1.0.0</li><li>ms-toolsai.jupyter-renderers-1.0.7</li><li>ms-vscode.makefile-tools-0.5.0</li><li>njpwerner.autodocstring-0.6.1</li></ul><p>下图则是运行 django 之后的负载情况.</p><p><img src="https://raw.githubusercontent.com/zxjlm/my-static-files/main/img/docker-attach-django.png" alt="docker-djagno" loading="lazy"></p><h4 id="pycharm"><a href="#pycharm" class="headerlink" title="pycharm"></a>pycharm</h4><p><img src="https://raw.githubusercontent.com/zxjlm/my-static-files/main/img/pycharm-compose.png" alt="pycharm-django" loading="lazy"></p><h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul><li><a target="_blank" rel="noopener" href="https://www.jetbrains.com/help/pycharm/using-docker-compose-as-a-remote-interpreter.html">Configure an interpreter using Docker Compose</a></li><li><a target="_blank" rel="noopener" href="https://www.freecodecamp.org/news/how-to-ssh-into-a-docker-container-secure-shell-vs-docker-attach/">How to SSH into a Docker Container – Secure Shell vs Docker Attach</a></li><li><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/attach/">docker attach</a></li><li><a target="_blank" rel="noopener" href="https://code.visualstudio.com/docs/remote/containers#_working-with-containers">Developing inside a Container</a></li><li><a target="_blank" rel="noopener" href="https://code.visualstudio.com/docs/remote/create-dev-container">Create a development container</a></li></ul></div><div id="reward-container"><span class="hty-icon-button button-glow" id="reward-button" title="打赏" onclick="var qr = document.getElementById(&quot;qr&quot;); qr.style.display = (qr.style.display === &quot;none&quot;) ? &quot;block&quot; : &quot;none&quot;;"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-hand-coin-line"></use></svg></span><div id="reward-comment">I'm so cute. Please give me money.</div><div id="qr" style="display:none"><div style="display:inline-block"><a target="_blank" rel="noopener" href="https://harumona-blog.oss-cn-beijing.aliyuncs.com/blog/IMG_3741.JPG"><img loading="lazy" src="https://harumona-blog.oss-cn-beijing.aliyuncs.com/blog/IMG_3741.JPG" alt="支付宝" title="支付宝"></a><div><span style="color:#00a3ee"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-alipay-line"></use></svg></span></div></div><div style="display:inline-block"></div><div style="display:inline-block"><a target="_blank" rel="noopener" href="https://harumona-blog.oss-cn-beijing.aliyuncs.com/blog/IMG_3742.JPG"><img loading="lazy" src="https://harumona-blog.oss-cn-beijing.aliyuncs.com/blog/IMG_3742.JPG" alt="微信支付" title="微信支付"></a><div><span style="color:#2dc100"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-wechat-pay-line"></use></svg></span></div></div></div></div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者：</strong>harumonia</li><li class="post-copyright-link"><strong>本文链接：</strong><a href="https://blog.harumonia.moe/pycharm-docker-compose-mode/" title="Pycharm 和 VSCode 的 docker compose 开发模式">https://blog.harumonia.moe/pycharm-docker-compose-mode/</a></li><li class="post-copyright-license"><strong>版权声明：</strong>本博客所有文章除特别声明外，均默认采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener" title="CC BY-NC-SA 4.0 "><svg class="icon"><use xlink:href="#icon-creative-commons-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-by-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-nc-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-sa-line"></use></svg></a>许可协议。</li></ul></section></article><div class="post-nav"><div class="post-nav-item"><a class="post-nav-prev" href="/2022-4-7/" rel="prev" title="2022.4~.7 生活小结"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-left-s-line"></use></svg><span class="post-nav-text">2022.4~.7 生活小结</span></a></div><div class="post-nav-item"><a class="post-nav-next" href="/new-mac-software-init/" rel="next" title="开发人员的Mac软件推荐列表(持续更新)"><span class="post-nav-text">开发人员的Mac软件推荐列表(持续更新)</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-right-s-line"></use></svg></a></div></div></div><div class="hty-card" id="comment"><div class="comment-tooltip text-center"><span>要不要和我说些什么？</span><br></div></div></main><footer class="sidebar-translate" id="footer"><div class="copyright"><span>&copy; 2018 – 2022 </span><span class="with-love" id="animate"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-cloud-line"></use></svg></span><span class="author">harumonia</span></div><div class="live_time"><span>本博客已萌萌哒地运行</span><span id="display_live_time"></span><span class="moe-text">(●'◡'●)</span><script>function blog_live_time() {
  setTimeout(blog_live_time, 1000);
  const start = new Date('2018-10-25T00:00:00');
  const now = new Date();
  const timeDiff = (now.getTime() - start.getTime());
  const msPerMinute = 60 * 1000;
  const msPerHour = 60 * msPerMinute;
  const msPerDay = 24 * msPerHour;
  const passDay = Math.floor(timeDiff / msPerDay);
  const passHour = Math.floor((timeDiff % msPerDay) / 60 / 60 / 1000);
  const passMinute = Math.floor((timeDiff % msPerHour) / 60 / 1000);
  const passSecond = Math.floor((timeDiff % msPerMinute) / 1000);
  display_live_time.innerHTML = " " + passDay + " 天 " + passHour + " 小时 " + passMinute + " 分 " + passSecond + " 秒";
}
blog_live_time();</script></div></footer><a class="hty-icon-button" id="back-to-top" aria-label="back-to-top" href="#"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-up-s-line"></use></svg><svg class="progress-circle-container" viewBox="0 0 100 100"><circle class="progress-circle" id="progressCircle" cx="50" cy="50" r="48" fill="none" stroke="#0078E7" stroke-width="2" stroke-linecap="round"></circle></svg></a><a class="popup-trigger hty-icon-button icon-search" id="search" target="_blank" rel="noopener" href="https://www.google.com/search?q=site:harumonia.moe" title="搜索"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-search-line"></use></svg></span></a></div></body></html>