<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="theme-color" content="#0078E7"><meta name="author" content="harumonia"><meta name="copyright" content="harumonia"><meta name="generator" content="Hexo 6.0.0"><meta name="theme" content="hexo-theme-yun"><title>2022-11-14-pytest_mock_counter | Zaxon</title><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@900&amp;display=swap" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/star-markdown-css@0.1.25/dist/yun/yun-markdown.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prism-theme-vars/base.css"><script src="//at.alicdn.com/t/font_1140697_j5gk85dg4pf.js" async></script><script src="https://cdn.jsdelivr.net/npm/scrollreveal/dist/scrollreveal.min.js" defer></script><script>function initScrollReveal() {
  [".post-card",".markdown-body img",".post-content img"].forEach((target)=> {
    ScrollReveal().reveal(target);
  })
}
document.addEventListener("DOMContentLoaded", initScrollReveal);
document.addEventListener("pjax:success", initScrollReveal);</script><link rel="icon" type="image/svg+xml" href="/yun.svg"><link rel="mask-icon" href="/yun.svg" color="#0078E7"><link rel="preload" href="/css/hexo-theme-yun.css" as="style"><link rel="preload" href="/js/utils.js" as="script"><link rel="preload" href="/js/hexo-theme-yun.js" as="script"><link rel="prefetch" href="/js/sidebar.js" as="script"><link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin><link rel="preconnect" href="https://cdn.jsdelivr.net/npm/" crossorigin><script id="yun-config">window.Yun={},window.CONFIG={hostname:"blog.harumonia.moe",root:"/",title:"迷雾中的藏宝地",version:"1.10.9",mode:"auto",copycode:!0,page:{isPost:!0},i18n:{placeholder:"搜索...",empty:"找不到您查询的内容: ${query}",hits:"找到 ${hits} 条结果",hits_time:"找到 ${hits} 条结果（用时 ${time} 毫秒）"},anonymous_image:"https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/avatar/none.jpg",say:{api:"https://v1.hitokoto.cn",hitokoto:!0},fireworks:{colors:["102, 167, 221","62, 131, 225","33, 78, 194"]},vendors:{host:"https://cdn.jsdelivr.net/npm/",darken:"https://cdn.jsdelivr.net/npm/darken@1.5.0"}}</script><link rel="stylesheet" href="/css/hexo-theme-yun.css"><script src="/js/hexo-theme-yun.js" type="module"></script><script src="/js/utils.js"></script><script src="/js/hexo-theme-yun.js"></script><link rel="alternate" href="/atom.xml" title="Zaxon" type="application/atom+xml"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin><script async src="https://www.googletagmanager.com/gtag/js?id=G-EBNGE3F0F6"></script><script>function gtag(){dataLayer.push(arguments)}CONFIG.hostname===location.hostname&&(window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-EBNGE3F0F6"))</script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><meta name="description" content="前言本篇的目的是在 Python 的 Test 框架中添加一个 mock 函数使用计数器 的逻辑. 该计数器的目的是, 在调用第三方api接口时, 计算某一个流程中的调用次数是否合理. 在流程(或调用关系)比较复杂的时候实用性较高."><meta property="og:type" content="article"><meta property="og:title" content="2022-11-14-pytest_mock_counter"><meta property="og:url" content="https://blog.harumonia.moe/2022-11-14-pytest-mock-counter/index.html"><meta property="og:site_name" content="Zaxon"><meta property="og:description" content="前言本篇的目的是在 Python 的 Test 框架中添加一个 mock 函数使用计数器 的逻辑. 该计数器的目的是, 在调用第三方api接口时, 计算某一个流程中的调用次数是否合理. 在流程(或调用关系)比较复杂的时候实用性较高."><meta property="og:locale" content="zh_CN"><meta property="article:published_time" content="2022-11-15T11:20:44.000Z"><meta property="article:modified_time" content="2023-01-31T13:36:43.413Z"><meta property="article:author" content="harumonia"><meta property="article:tag" content="Python"><meta property="article:tag" content="Test"><meta name="twitter:card" content="summary"><script>(function() {
  if (CONFIG.mode !== 'auto') return
  const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches
  const setting = localStorage.getItem('darken-mode') || 'auto'
  if (setting === 'dark' || (prefersDark && setting !== 'light'))
    document.documentElement.classList.toggle('dark', true)
})()</script></head><body><script src="https://code.iconify.design/2/2.1.1/iconify.min.js"></script><script>IconifyProviders={"":{resources:["https://api.iconify.design"],rotate:1e3}}</script><script defer src="https://cdn.jsdelivr.net/npm/animejs@latest"></script><script defer src="/js/ui/fireworks.js" type="module"></script><canvas class="fireworks"></canvas><div class="container"><a class="sidebar-toggle hty-icon-button" id="menu-btn"><div class="hamburger hamburger--spin" type="button"><span class="hamburger-box"><span class="hamburger-inner"></span></span></div></a><div class="sidebar-toggle sidebar-overlay"></div><aside class="sidebar"><script src="/js/sidebar.js" type="module"></script><ul class="sidebar-nav"><li class="sidebar-nav-item sidebar-nav-toc hty-icon-button sidebar-nav-active" data-target="post-toc-wrap" title="文章目录"><span class="icon iconify" data-icon="ri:list-ordered"></span></li><li class="sidebar-nav-item sidebar-nav-overview hty-icon-button" data-target="site-overview-wrap" title="站点概览"><span class="icon iconify" data-icon="ri:passport-line"></span></li></ul><div class="sidebar-panel" id="site-overview-wrap"><div class="site-info fix-top"><a class="site-author-avatar" href="/about/" title="harumonia"><img width="96" loading="lazy" src="https://harumona-blog.oss-cn-beijing.aliyuncs.com/blog/Ocabe.webp" alt="harumonia"></a><div class="site-author-name"><a href="/about/">harumonia</a></div><span class="site-name">Zaxon</span><sub class="site-subtitle">Find the key of soul</sub><div class="site-description">lazy</div></div><nav class="site-state"><a class="site-state-item hty-icon-button icon-home" href="/" title="首页"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-home-4-line"></use></svg></span></a><div class="site-state-item"><a href="/archives/" title="归档"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-archive-line"></use></svg></span><span class="site-state-item-count">137</span></a></div><div class="site-state-item"><a href="/categories/" title="分类"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-folder-2-line"></use></svg></span><span class="site-state-item-count">15</span></a></div><div class="site-state-item"><a href="/tags/" title="标签"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="site-state-item-count">71</span></a></div><a class="site-state-item hty-icon-button" href="/bangumis/index.html" title="bangumi"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-book-2-line"></use></svg></span></a></nav><hr style="margin-bottom:.5rem"><div class="links-of-author"><a class="links-of-author-item hty-icon-button" rel="noopener" href="/atom.xml" title="RSS" target="_blank" style="color:orange"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-rss-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://qm.qq.com/cgi-bin/qm/qr?k=DSmoEtSKHITcV9pghYqqmSQ80-SPnPjm&amp;noverify=0" title="QQ" target="_blank" style="color:#12b7f5"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-qq-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://github.com/zxjlm" title="GitHub" target="_blank" style="color:#6e5494"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-github-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://www.douban.com/people/Zxj_Butterfly_m/" title="豆瓣" target="_blank" style="color:#072"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-douban-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://music.163.com/#/user/home?id=305617499" title="网易云音乐" target="_blank" style="color:#c20c0c"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-netease-cloud-music-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://space.bilibili.com/1801214" title="哔哩哔哩" target="_blank" style="color:#ff8eb3"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-bilibili-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://twitter.com/Harumonia1996" title="Twitter" target="_blank" style="color:#1da1f2"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-twitter-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="mailto:zxjlm233@gmail.com" title="E-Mail" target="_blank" style="color:#8e71c1"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-mail-line"></use></svg></a></div><hr style="margin:.5rem 1rem"><div class="links"><a class="links-item hty-icon-button" href="/links/" title="我的小伙伴们" style="color:#1e90ff"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-genderless-line"></use></svg></a></div><br><a class="links-item hty-icon-button" id="toggle-mode-btn" href="javascript:;" title="Mode" style="color:#f1cb64"><span class="icon iconify" data-icon="ri:contrast-2-line"></span></a></div><div class="sidebar-panel sidebar-panel-active" id="post-toc-wrap"><div class="post-toc"><div class="post-toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9D%E6%9C%9F%E8%AE%BE%E8%AE%A1"><span class="toc-number">2.</span> <span class="toc-text">初期设计</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%80%E5%8F%91%E9%98%B6%E6%AE%B5"><span class="toc-number">3.</span> <span class="toc-text">开发阶段</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E4%BB%A3%E7%A0%81"><span class="toc-number">3.1.</span> <span class="toc-text">原代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%A1%E6%95%B0%E5%99%A8%E8%AE%BE%E8%AE%A1"><span class="toc-number">3.2.</span> <span class="toc-text">计数器设计</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%98%E5%8C%96"><span class="toc-number">3.3.</span> <span class="toc-text">优化</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">4.</span> <span class="toc-text">总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Reference"><span class="toc-number">5.</span> <span class="toc-text">Reference</span></a></li></ol></div></div></div></aside><main class="sidebar-translate" id="content"><div id="post"><article class="hty-card post-block" itemscope itemtype="https://schema.org/Article" style="--smc-primary:#0078E7"><link itemprop="mainEntityOfPage" href="https://blog.harumonia.moe/2022-11-14-pytest-mock-counter/"><span hidden itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="name" content="harumonia"><meta itemprop="description"></span><span hidden itemprop="publisher" itemscope itemtype="https://schema.org/Organization"><meta itemprop="name" content="Zaxon"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">2022-11-14-pytest_mock_counter</h1><div class="post-meta"><div class="post-time"><span class="post-meta-item-icon"><span class="icon iconify" data-icon="ri:calendar-line"></span></span> <time title="创建时间：2022-11-15 11:20:44" itemprop="dateCreated datePublished" datetime="2022-11-15T11:20:44+00:00">2022-11-15</time><span class="post-meta-divider">-</span><span class="post-meta-item-icon"><span class="icon iconify" data-icon="ri:calendar-2-line"></span></span> <time title="修改时间：2023-01-31 13:36:43" itemprop="dateModified" datetime="2023-01-31T13:36:43+00:00">2023-01-31</time></div><div class="post-classify"><span class="post-category"><span class="post-meta-item-icon" style="margin-right:3px"><span class="icon iconify" data-icon="ri:folder-line"></span></span><span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a class="category-item" href="/categories/%E6%BA%90%E6%B5%81%E6%B8%85%E6%B3%89/" style="--text-color:var(--hty-text-color)" itemprop="url" rel="index"><span itemprop="text">源流清泉</span></a></span> > <span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a class="category-item" href="/categories/%E6%BA%90%E6%B5%81%E6%B8%85%E6%B3%89/Python/" style="--text-color:var(--hty-text-color)" itemprop="url" rel="index"><span itemprop="text">Python</span></a></span></span><span class="post-tag"><span class="post-meta-divider">-</span><a class="tag-item" href="/tags/Python/" style="--text-color:#3776ab"><span class="post-meta-item-icon"><span class="icon iconify" data-icon="ri:price-tag-3-line"></span></span><span class="tag-name">Python</span></a><a class="tag-item" href="/tags/Test/" style="--text-color:var(--hty-text-color)"><span class="post-meta-item-icon"><span class="icon iconify" data-icon="ri:price-tag-3-line"></span></span><span class="tag-name">Test</span></a></span></div><div class="post-author"><div class="author-avatar"><img src="https://www.gravatar.com/avatar/170126958484dfae0e26934864b36b4e?s=20&amp;d=https%3A%2F%2Fcdn.jsdelivr.net%2Fgh%2FYunYouJun%2Fcdn%2Fimg%2Favatar%2Fnone.jpg"></div><span class="author-name">harumonia</span></div></div></header><section class="post-body" itemprop="articleBody"><div class="post-content markdown-body"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>本篇的目的是在 <code>Python</code> 的 Test 框架中添加一个 <strong>mock 函数使用计数器</strong> 的逻辑. 该计数器的目的是, 在调用第三方api接口时, 计算某一个流程中的调用次数是否合理. 在流程(或调用关系)比较复杂的时候实用性较高.</p><span id="more"></span><h2 id="初期设计"><a href="#初期设计" class="headerlink" title="初期设计"></a>初期设计</h2><p>初期设计考虑两个方面.</p><ol><li><p>计数器的设计<br>计数器应该具有一定的扩展性. 因为不同的流程所调用的接口可能不同. 除此之外, 计数器应该是一个独立的对象, 能够对结果进行校验与反馈. 所以在设计初期笔者选择是使用观察者模式进行设计.</p></li><li><p>注入流程的设计<br>注入流程应该尽量简单, 改动较小. 目的是能够通过在现有代码上添加装饰器的方法, 实现最小限度的更改(实际上这也是比较科学的更改).</p></li></ol><h2 id="开发阶段"><a href="#开发阶段" class="headerlink" title="开发阶段"></a>开发阶段</h2><h3 id="原代码"><a href="#原代码" class="headerlink" title="原代码"></a>原代码</h3><p>这里先贴一下需要进行优化的代码. 这是对代码模型进行了简化之后的结果, __mock_collect()__ 中包含的 <code>check_items</code> 这个 mock 则是实际我们调用的第三方接口, 它会从 <code>item_manager</code> 中得到玩家目前所拥有的道具.</p><p>目前需要解决的就是, 在业务函数的运行流程中计算 <code>check_items</code> 这个函数一共调用了多少次. 因为实际上在业务运行是, 默认是不会出现流程外的道具变动, 所以这个函数只需要调用一次就能实现业务的流转, 更多次数的调用就有点浪费性能了.</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">TestCase</span><span class="token punctuation">:</span>
    item_manager <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">101</span><span class="token punctuation">,</span> <span class="token number">999</span><span class="token punctuation">]</span> <span class="token comment"># 简化, 非关键的内容</span>
    
    <span class="token keyword">def</span> <span class="token function">get_item_manager</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span>_<span class="token punctuation">,</span> <span class="token operator">**</span>__<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>item_manager

    <span class="token keyword">def</span> <span class="token function">mock_collect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        这里是存放 mock 函数的集合
        """</span>
        self<span class="token punctuation">.</span>mocker <span class="token operator">=</span> patch<span class="token punctuation">.</span><span class="token builtin">object</span><span class="token punctuation">(</span>
            api<span class="token punctuation">,</span> <span class="token string">"check_items"</span><span class="token punctuation">,</span> new<span class="token operator">=</span>self<span class="token punctuation">.</span>get_item_manager
        <span class="token punctuation">)</span>
        <span class="token comment"># ... other mocks</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="计数器设计"><a href="#计数器设计" class="headerlink" title="计数器设计"></a>计数器设计</h3><p>单纯的计数器实现是很容易的, 我们可以设计一个 <code>Counter</code> 类, 它包含一个 <em>int</em> 类型的 <code>cnt</code> 类变量. 同时, <em>尽量少的更改</em> 意味着我们最好在源头的进行改动, 所以, 在每次调用 <code>get_item_manager</code> 这个函数的时候, 顺便对 <code>cnt</code> 变量进行自增即可.</p><p>但是实际上我们调用的 api 不止一个, 所以我们需要对 <code>Counter</code> 进行优化, 比如将 <code>cnt</code> 变为一个 <code>Dict[str, int]</code> 类型的变量 <code>func_cnt_mapping</code>. 但是这意味着我们需要进入到每个函数的内部, 然后加上 <code>func_cnt_mapping[func_name] += 1</code> 之类的奇怪写法, 甚至还需要加上 <code>func_cnt_mappint.setdefault(func_name, 0)</code> 这样的语法来提前声明.</p><p>于是, 很自然地笔者开始对该计数思路进行<code>装饰器改造</code>. 最初的改造结果如下所示.</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">Counter</span><span class="token punctuation">:</span>
<span class="token keyword">def</span> <span class="token function">decorate</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token decorator annotation punctuation">@dataclasses<span class="token punctuation">.</span>dataclass</span>
    <span class="token keyword">class</span> <span class="token class-name">CC</span><span class="token punctuation">:</span>
        cnt<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">0</span>

    counter <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
    
    <span class="token decorator annotation punctuation">@classmethod</span>
    <span class="token keyword">def</span> <span class="token function">incr</span><span class="token punctuation">(</span>cls<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">def</span> <span class="token function">decorate</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token decorator annotation punctuation">@wraps</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span>
            <span class="token keyword">def</span> <span class="token function">wrapper</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">if</span> func<span class="token punctuation">.</span>__qualname__ <span class="token keyword">not</span> <span class="token keyword">in</span> cls<span class="token punctuation">.</span>counter<span class="token punctuation">:</span>
                    cls<span class="token punctuation">.</span>counter<span class="token punctuation">[</span>func<span class="token punctuation">.</span>__qualname__<span class="token punctuation">]</span> <span class="token operator">=</span> cls<span class="token punctuation">.</span>CC<span class="token punctuation">(</span><span class="token punctuation">)</span>
                cnt_obj <span class="token operator">=</span> cls<span class="token punctuation">.</span>counter<span class="token punctuation">[</span>func<span class="token punctuation">.</span>__qualname__<span class="token punctuation">]</span>
                cnt_obj<span class="token punctuation">.</span>cnt <span class="token operator">+=</span> <span class="token number">1</span>
                <span class="token keyword">return</span> func<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>

            <span class="token keyword">return</span> wrapper

        <span class="token keyword">return</span> decorate<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>该装饰器会在初次进入的时候, 生成一个函数命名(含 namespace )与计数器(<em>CC</em>) 的映射关系, 然后在每次进入的时候对关联的计数器进行自增. 其调用方式如下所示.</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token decorator annotation punctuation">@Counter<span class="token punctuation">.</span>incr</span>
<span class="token keyword">def</span> <span class="token function">get_item_manager</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span>_<span class="token punctuation">,</span> <span class="token operator">**</span>__<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> self<span class="token punctuation">.</span>item_manager<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="优化"><a href="#优化" class="headerlink" title="优化"></a>优化</h3><p>到这一步, 我们可以在业务流程开始的时候初始化一下 <code>Counter</code>, 然后在业务流程结束的时候遍历一下 <code>Counter</code> 所挂载的各个函数与其计数, 看看是否符合预期即可.</p><p>但是这又需要我们在每个业务流程的前后写大量的 <strong>初始化</strong> 和 <strong>判断</strong> 代码, 于是笔者使用 <strong>上下文机制</strong> 来进行进一步的优化.</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">Gestapo</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__enter__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        Counter<span class="token punctuation">.</span>counter <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>

    <span class="token keyword">def</span> <span class="token function">__exit__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> exc_type<span class="token punctuation">,</span> exc_val<span class="token punctuation">,</span> exc_tb<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> name<span class="token punctuation">,</span> cc_ <span class="token keyword">in</span> Counter<span class="token punctuation">.</span>counter<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> cc_<span class="token punctuation">.</span>cnt <span class="token operator">></span> cc_<span class="token punctuation">.</span>thresh_hold<span class="token punctuation">:</span>
                <span class="token keyword">raise</span> AssertionError<span class="token punctuation">(</span>cc_<span class="token punctuation">)</span>

        Counter<span class="token punctuation">.</span>counter<span class="token punctuation">.</span>clear<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在 <code>CC</code> 中加入一个 <code>thresh_hold</code> 成员, 这是允许调用的最大次数, 然后在函数对出的时候, 校验一下 <code>cc_.cnt</code> 与 <code>cc.thresh_hold</code> 的关系, 就可以知道函数的调用此时是否超限.</p><p>不过在抛出超限异常的时候 (<code>raise AssertionError(cc_)</code>), 笔者希望得到更具体的一些报错的信息, 所以可以对 <code>CC</code> 的输出进行一个优化.</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">
<span class="token keyword">class</span> <span class="token class-name">Counter</span><span class="token punctuation">:</span>
    <span class="token keyword">class</span> <span class="token class-name">CC</span><span class="token punctuation">:</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">def</span> <span class="token function">__repr__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>
            <span class="token string-interpolation"><span class="token string">f"\n"</span></span>
            <span class="token string-interpolation"><span class="token string">f"cnt: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>self<span class="token punctuation">.</span>cnt<span class="token punctuation">&#125;</span></span><span class="token string"> but except\n"</span></span>
            <span class="token string-interpolation"><span class="token string">f"stack:\n</span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token string-interpolation"><span class="token string">f'-----------</span><span class="token interpolation"><span class="token punctuation">&#123;</span>os<span class="token punctuation">.</span>linesep<span class="token punctuation">&#125;</span></span><span class="token string">'</span></span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>self<span class="token punctuation">.</span>stack<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span>
        <span class="token punctuation">)</span>
    
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token decorator annotation punctuation">@classmethod</span>
    <span class="token keyword">def</span> <span class="token function">incr</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> thresh_hold<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">def</span> <span class="token function">decorate</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token decorator annotation punctuation">@wraps</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span>
            <span class="token keyword">def</span> <span class="token function">wrapper</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                call_stack <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
                <span class="token keyword">for</span> line <span class="token keyword">in</span> traceback<span class="token punctuation">.</span>format_stack<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                    <span class="token keyword">if</span> re<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">"..."</span><span class="token punctuation">,</span> line<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment"># 匹配关键的调用栈</span>
                        call_stack<span class="token punctuation">.</span>append<span class="token punctuation">(</span>line<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                cnt_obj<span class="token punctuation">.</span>stack<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>call_stack<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> func<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>

            <span class="token keyword">return</span> wrapper

        <span class="token keyword">return</span> decorate<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>通过修改 <em>magic_method</em> , 来实现 <code>CC</code> 对象的默认输出内容. 然后使用 <code>traceback</code> 模块来追踪调用到这个函数的上下文, 从而判断哪些上下文中的接口调用方式是可以优化的.</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>我们的最终代码形式如下所示. 不只是第三方接口调用, 在任何需要进行计数的地方(函数)都可以挂上该计数器.</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">Counter</span><span class="token punctuation">:</span>
    <span class="token decorator annotation punctuation">@dataclasses<span class="token punctuation">.</span>dataclass</span>
    <span class="token keyword">class</span> <span class="token class-name">CC</span><span class="token punctuation">:</span>
        thresh_hold<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">1</span>
        cnt<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">0</span>
        stack<span class="token punctuation">:</span> typing<span class="token punctuation">.</span>List<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span> <span class="token operator">=</span> dataclasses<span class="token punctuation">.</span>field<span class="token punctuation">(</span>default_factory<span class="token operator">=</span><span class="token builtin">list</span><span class="token punctuation">)</span>

        <span class="token keyword">def</span> <span class="token function">clear</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>cnt <span class="token operator">=</span> <span class="token number">0</span>
            self<span class="token punctuation">.</span>stack<span class="token punctuation">.</span>clear<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword">def</span> <span class="token function">__repr__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span>
                <span class="token string-interpolation"><span class="token string">f"\n"</span></span>
                <span class="token string-interpolation"><span class="token string">f"cnt: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>self<span class="token punctuation">.</span>cnt<span class="token punctuation">&#125;</span></span><span class="token string"> but except\n"</span></span>
                <span class="token string-interpolation"><span class="token string">f"stack:\n</span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token string-interpolation"><span class="token string">f'-----------</span><span class="token interpolation"><span class="token punctuation">&#123;</span>os<span class="token punctuation">.</span>linesep<span class="token punctuation">&#125;</span></span><span class="token string">'</span></span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>self<span class="token punctuation">.</span>stack<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span>
            <span class="token punctuation">)</span>

    <span class="token keyword">class</span> <span class="token class-name">Gestapo</span><span class="token punctuation">:</span>
        <span class="token keyword">def</span> <span class="token function">__enter__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
            Counter<span class="token punctuation">.</span>counter <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>

        <span class="token keyword">def</span> <span class="token function">__exit__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> exc_type<span class="token punctuation">,</span> exc_val<span class="token punctuation">,</span> exc_tb<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">for</span> name<span class="token punctuation">,</span> cc_ <span class="token keyword">in</span> Counter<span class="token punctuation">.</span>counter<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">if</span> cc_<span class="token punctuation">.</span>cnt <span class="token operator">></span> cc_<span class="token punctuation">.</span>thresh_hold<span class="token punctuation">:</span>
                    <span class="token keyword">raise</span> AssertionError<span class="token punctuation">(</span>cc_<span class="token punctuation">)</span>

            Counter<span class="token punctuation">.</span>counter<span class="token punctuation">.</span>clear<span class="token punctuation">(</span><span class="token punctuation">)</span>

    counter<span class="token punctuation">:</span> typing<span class="token punctuation">.</span>Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> CC<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>

    <span class="token decorator annotation punctuation">@classmethod</span>
    <span class="token keyword">def</span> <span class="token function">incr</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> thresh_hold<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">def</span> <span class="token function">decorate</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token decorator annotation punctuation">@wraps</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span>
            <span class="token keyword">def</span> <span class="token function">wrapper</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">if</span> func<span class="token punctuation">.</span>__qualname__ <span class="token keyword">not</span> <span class="token keyword">in</span> cls<span class="token punctuation">.</span>counter<span class="token punctuation">:</span>
                    cls<span class="token punctuation">.</span>counter<span class="token punctuation">[</span>func<span class="token punctuation">.</span>__qualname__<span class="token punctuation">]</span> <span class="token operator">=</span> cls<span class="token punctuation">.</span>CC<span class="token punctuation">(</span>thresh_hold<span class="token operator">=</span>thresh_hold<span class="token punctuation">)</span>
                cnt_obj <span class="token operator">=</span> cls<span class="token punctuation">.</span>counter<span class="token punctuation">[</span>func<span class="token punctuation">.</span>__qualname__<span class="token punctuation">]</span>
                cnt_obj<span class="token punctuation">.</span>cnt <span class="token operator">+=</span> <span class="token number">1</span>
                call_stack <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
                <span class="token keyword">for</span> line <span class="token keyword">in</span> traceback<span class="token punctuation">.</span>format_stack<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                    <span class="token keyword">if</span> re<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">"..."</span><span class="token punctuation">,</span> line<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment"># 匹配关键的调用栈</span>
                        call_stack<span class="token punctuation">.</span>append<span class="token punctuation">(</span>line<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                cnt_obj<span class="token punctuation">.</span>stack<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>call_stack<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> func<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>

            <span class="token keyword">return</span> wrapper

        <span class="token keyword">return</span> decorate<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul><li><a target="_blank" rel="noopener" href="https://towardsdatascience.com/how-to-add-new-line-in-python-f-strings-7b4ccc605f4a">How to Add New Line in Python f-strings</a></li><li><a target="_blank" rel="noopener" href="https://docs.python.org/3/library/traceback.html">Python trackback</a></li><li><a target="_blank" rel="noopener" href="https://docs.python.org/3/library/dataclasses.html">Python dataclasses</a></li></ul></div></section><div id="reward-container"><span class="hty-icon-button button-glow" id="reward-button" title="打赏" onclick="var qr = document.getElementById(&quot;qr&quot;); qr.style.display = (qr.style.display === &quot;none&quot;) ? &quot;block&quot; : &quot;none&quot;;"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-hand-coin-line"></use></svg></span><div id="reward-comment">I'm so cute. Please give me money.</div><div id="qr" style="display:none"><div style="display:inline-block"><a target="_blank" rel="noopener" href="https://harumona-blog.oss-cn-beijing.aliyuncs.com/blog/IMG_3741.JPG"><img loading="lazy" src="https://harumona-blog.oss-cn-beijing.aliyuncs.com/blog/IMG_3741.JPG" alt="支付宝" title="支付宝"></a><div><span style="color:#00a3ee"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-alipay-line"></use></svg></span></div></div><div style="display:inline-block"></div><div style="display:inline-block"><a target="_blank" rel="noopener" href="https://harumona-blog.oss-cn-beijing.aliyuncs.com/blog/IMG_3742.JPG"><img loading="lazy" src="https://harumona-blog.oss-cn-beijing.aliyuncs.com/blog/IMG_3742.JPG" alt="微信支付" title="微信支付"></a><div><span style="color:#2dc100"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-wechat-pay-line"></use></svg></span></div></div></div></div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者：</strong>harumonia</li><li class="post-copyright-link"><strong>本文链接：</strong><a href="https://blog.harumonia.moe/2022-11-14-pytest-mock-counter/" title="2022-11-14-pytest_mock_counter">https://blog.harumonia.moe/2022-11-14-pytest-mock-counter/</a></li><li class="post-copyright-license"><strong>版权声明：</strong>本博客所有文章除特别声明外，均默认采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener" title="CC BY-NC-SA 4.0 "><span class="icon iconify" data-icon="ri:creative-commons-line"></span><span class="icon iconify" data-icon="ri:creative-commons-by-line"></span><span class="icon iconify" data-icon="ri:creative-commons-nc-line"></span><span class="icon iconify" data-icon="ri:creative-commons-sa-line"></span></a> 许可协议。</li></ul></article><div class="post-nav"><div class="post-nav-item"><a class="post-nav-prev" href="/2022-11-15-alfred-workflow-dev/" rel="prev" title="alfred 工作流开发"><span class="icon iconify" data-icon="ri:arrow-left-s-line"></span><span class="post-nav-text">alfred 工作流开发</span></a></div><div class="post-nav-item"><a class="post-nav-next" href="/2022-10-10-C3-Storage-and-Retrieval/" rel="next" title="C3. Storage and Retrieval (更新中)"><span class="post-nav-text">C3. Storage and Retrieval (更新中)</span><span class="icon iconify" data-icon="ri:arrow-right-s-line"></span></a></div></div></div><div class="hty-card" id="comment"></div></main><footer class="sidebar-translate" id="footer"><div class="copyright"><span>&copy; 2018 – 2023 </span><span class="with-love" id="animate"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-cloud-line"></use></svg></span><span class="author">harumonia</span></div><div class="live-time"><span>本博客已萌萌哒地运行</span><span id="display_live_time"></span><span class="moe-text">(●'◡'●)</span><script>function blog_live_time() {
  setTimeout(blog_live_time, 1000);
  const start = new Date('2018-10-25T00:00:00');
  const now = new Date();
  const timeDiff = (now.getTime() - start.getTime());
  const msPerMinute = 60 * 1000;
  const msPerHour = 60 * msPerMinute;
  const msPerDay = 24 * msPerHour;
  const passDay = Math.floor(timeDiff / msPerDay);
  const passHour = Math.floor((timeDiff % msPerDay) / 60 / 60 / 1000);
  const passMinute = Math.floor((timeDiff % msPerHour) / 60 / 1000);
  const passSecond = Math.floor((timeDiff % msPerMinute) / 1000);
  display_live_time.innerHTML = ` ${passDay} 天 ${passHour} 小时 ${passMinute} 分 ${passSecond} 秒`;
}
blog_live_time();</script></div></footer></div><a class="hty-icon-button" id="back-to-top" aria-label="back-to-top" href="#"><span class="icon iconify" data-icon="ri:arrow-up-s-line"></span><svg class="progress-circle-container" viewBox="0 0 100 100"><circle class="progress-circle" id="progressCircle" cx="50" cy="50" r="48" fill="none" stroke="#0078E7" stroke-width="2" stroke-linecap="round"></circle></svg></a><a class="popup-trigger hty-icon-button icon-search" id="search" target="_blank" rel="noopener" href="https://www.google.com/search?q=site:harumonia.moe" title="搜索"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:search-line"></span></span></a></body></html>