<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="theme-color" content="#0078E7"><meta name="author" content="harumonia"><meta name="copyright" content="harumonia"><meta name="generator" content="Hexo 5.1.1"><meta name="theme" content="hexo-theme-yun"><title>bash脚本 - 过期日志文件清理 | Zaxon</title><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@900&amp;display=swap" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/star-markdown-css@0.1.25/dist/yun/yun-markdown.min.css"><script src="//at.alicdn.com/t/font_1140697_j5gk85dg4pf.js" async></script><script src="https://cdn.jsdelivr.net/npm/scrollreveal/dist/scrollreveal.min.js" defer></script><script>document.addEventListener("DOMContentLoaded", () => {
  [".post-card",".post-content img"].forEach((target)=> {
    ScrollReveal().reveal(target);
  })
});</script><link id="light-prism-css" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@latest/themes/prism.css" media="(prefers-color-scheme:light)"><link id="dark-prism-css" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@latest/themes/prism-tomorrow.css" media="(prefers-color-scheme:dark)"><link rel="icon" href="/yun.svg"><link rel="mask-icon" href="/yun.svg" color="#0078E7"><link rel="alternate icon" href="/yun.ico"><link rel="preload" href="/css/hexo-theme-yun.css" as="style"><link rel="preload" href="/js/utils.js" as="script"><link rel="preload" href="/js/hexo-theme-yun.js" as="script"><link rel="prefetch" href="/js/sidebar.js" as="script"><link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin><script id="yun-config">const Yun = window.Yun || {};
    window.CONFIG = {"hostname":"blog.harumonia.moe","root":"/","title":"Zaxon-迷雾中的藏宝地","version":"1.6.1","mode":"auto","copycode":true,"page":{"isPost":true},"i18n":{"placeholder":"搜索...","empty":"找不到您查询的内容: ${query}","hits":"找到 ${hits} 条结果","hits_time":"找到 ${hits} 条结果（用时 ${time} 毫秒）"},"anonymous_image":"https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/avatar/none.jpg","say":{"api":"https://v1.hitokoto.cn","hitokoto":true},"fireworks":{"colors":["102, 167, 221","62, 131, 225","33, 78, 194"]}};</script><link rel="stylesheet" href="/css/hexo-theme-yun.css"><script src="/js/utils.js"></script><script src="/js/hexo-theme-yun.js"></script><link rel="preconnect" href="https://www.google-analytics.com" crossorigin><script async src="https://www.googletagmanager.com/gtag/js?id=G-EBNGE3F0F6"></script><script>function gtag(){dataLayer.push(arguments)}CONFIG.hostname===location.hostname&&(window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-EBNGE3F0F6"))</script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><meta name="description" content="公司服务器上的日志文件多年积压, 已经占用了很大一部分不必要的内存空间. 所以本篇将完成一个功能性脚本, 其内容是扫描过期的日志文件, 并对文件进行对应的操作. 好久没有写过 bash 脚本了, 本篇也算是对这项技能的一个温习吧."><meta property="og:type" content="article"><meta property="og:title" content="bash脚本 - 过期日志文件清理"><meta property="og:url" content="https://blog.harumonia.moe/clean-logs/index.html"><meta property="og:site_name" content="Zaxon"><meta property="og:description" content="公司服务器上的日志文件多年积压, 已经占用了很大一部分不必要的内存空间. 所以本篇将完成一个功能性脚本, 其内容是扫描过期的日志文件, 并对文件进行对应的操作. 好久没有写过 bash 脚本了, 本篇也算是对这项技能的一个温习吧."><meta property="og:locale" content="zh_CN"><meta property="article:published_time" content="2021-09-17T22:03:57.000Z"><meta property="article:modified_time" content="2021-09-17T11:08:02.000Z"><meta property="article:author" content="harumonia"><meta property="article:tag" content="实用小工具"><meta property="article:tag" content="脚本"><meta name="twitter:card" content="summary"><script src="/js/ui/mode.js"></script></head><body><script defer src="https://cdn.jsdelivr.net/npm/animejs@latest"></script><script defer src="/js/ui/fireworks.js"></script><canvas class="fireworks"></canvas><div class="container"><a class="sidebar-toggle hty-icon-button" id="menu-btn"><div class="hamburger hamburger--spin" type="button"><span class="hamburger-box"><span class="hamburger-inner"></span></span></div></a><div class="sidebar-toggle sidebar-overlay"></div><aside class="sidebar"><script src="/js/sidebar.js"></script><ul class="sidebar-nav"><li class="sidebar-nav-item sidebar-nav-toc hty-icon-button sidebar-nav-active" data-target="post-toc-wrap" title="文章目录"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-list-ordered"></use></svg></li><li class="sidebar-nav-item sidebar-nav-overview hty-icon-button" data-target="site-overview-wrap" title="站点概览"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-passport-line"></use></svg></li></ul><div class="sidebar-panel" id="site-overview-wrap"><div class="site-info fix-top"><a class="site-author-avatar" href="/about/" title="harumonia"><img width="96" loading="lazy" src="https://harumona-blog.oss-cn-beijing.aliyuncs.com/blog/Ocabe.webp" alt="harumonia"></a><div class="site-author-name"><a href="/about/">harumonia</a></div><span class="site-name">Zaxon</span><sub class="site-subtitle">Find the key of soul</sub><div class="site-desciption">lazy</div></div><nav class="site-state"><a class="site-state-item hty-icon-button icon-home" href="/" title="首页"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-home-4-line"></use></svg></span></a><div class="site-state-item"><a href="/archives/" title="归档"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-archive-line"></use></svg></span><span class="site-state-item-count">128</span></a></div><div class="site-state-item"><a href="/categories/" title="分类"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-folder-2-line"></use></svg></span><span class="site-state-item-count">15</span></a></div><div class="site-state-item"><a href="/tags/" title="标签"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="site-state-item-count">69</span></a></div><a class="site-state-item hty-icon-button" href="/books" title="读书"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-book-2-line"></use></svg></span></a></nav><hr style="margin-bottom:.5rem"><div class="links-of-author"><a class="links-of-author-item hty-icon-button" rel="noopener" href="/atom.xml" title="RSS" target="_blank" style="color:orange"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-rss-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://qm.qq.com/cgi-bin/qm/qr?k=DSmoEtSKHITcV9pghYqqmSQ80-SPnPjm&amp;noverify=0" title="QQ" target="_blank" style="color:#12b7f5"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-qq-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://github.com/zxjlm" title="GitHub" target="_blank" style="color:#6e5494"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-github-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://www.douban.com/people/Zxj_Butterfly_m/" title="豆瓣" target="_blank" style="color:#072"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-douban-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://music.163.com/#/user/home?id=305617499" title="网易云音乐" target="_blank" style="color:#c20c0c"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-netease-cloud-music-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://space.bilibili.com/1801214" title="哔哩哔哩" target="_blank" style="color:#ff8eb3"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-bilibili-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://twitter.com/Harumonia1996" title="Twitter" target="_blank" style="color:#1da1f2"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-twitter-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="mailto:zxjlm233@gmail.com" title="E-Mail" target="_blank" style="color:#8e71c1"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-mail-line"></use></svg></a></div><hr style="margin:.5rem 1rem"><div class="links"><a class="links-item hty-icon-button" href="/links/" title="我的小伙伴们" style="color:#1e90ff"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-genderless-line"></use></svg></a></div><br><a class="links-item hty-icon-button" id="toggle-mode-btn" href="javascript:;" title="Mode" style="color:#f1cb64"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-contrast-2-line"></use></svg></a></div><div class="sidebar-panel sidebar-panel-active" id="post-toc-wrap"><div class="post-toc"><div class="post-toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%98%8E%E7%A1%AE%E9%9C%80%E6%B1%82"><span class="toc-number">1.</span> <span class="toc-text">明确需求</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%80%E5%B7%A5"><span class="toc-number">2.</span> <span class="toc-text">开工</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#bash-%E5%A4%8D%E4%B9%A0"><span class="toc-number">2.1.</span> <span class="toc-text">bash 复习</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9F%A5%E6%89%BE%E8%BF%87%E6%9C%9F%E6%96%87%E4%BB%B6"><span class="toc-number">3.</span> <span class="toc-text">查找过期文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%84%E7%90%86%E6%96%87%E4%BB%B6"><span class="toc-number">4.</span> <span class="toc-text">处理文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C"><span class="toc-number">5.</span> <span class="toc-text">文件操作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%8C%E6%95%B4%E7%9A%84%E8%84%9A%E6%9C%AC"><span class="toc-number">6.</span> <span class="toc-text">完整的脚本</span></a></li></ol></div></div></div></aside><main class="sidebar-translate" id="content"><div id="post"><article class="hty-card post-block" itemscope itemtype="https://schema.org/Article"><link itemprop="mainEntityOfPage" href="https://blog.harumonia.moe/clean-logs/"><span hidden itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="name" content="harumonia"><meta itemprop="description"></span><span hidden itemprop="publisher" itemscope itemtype="https://schema.org/Organization"><meta itemprop="name" content="Zaxon"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">bash脚本 - 过期日志文件清理</h1><div class="post-meta"><div class="post-time" style="display:inline-block"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-calendar-line"></use></svg></span><time title="创建时间：2021-09-17 22:03:57" itemprop="dateCreated datePublished" datetime="2021-09-17T22:03:57+00:00">2021-09-17</time></div><div class="post-classify"><span class="post-category"><span class="post-meta-item-icon" style="margin-right:3px"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-folder-line"></use></svg></span><span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a class="category-item" href="/categories/%E6%BA%90%E6%B5%81%E6%B8%85%E6%B3%89/" style="--text-color:var(--hty-text-color)" itemprop="url" rel="index"><span itemprop="text">源流清泉</span></a></span> > <span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a class="category-item" href="/categories/%E6%BA%90%E6%B5%81%E6%B8%85%E6%B3%89/Shell/" style="--text-color:var(--hty-text-color)" itemprop="url" rel="index"><span itemprop="text">Shell</span></a></span></span><span class="post-tag"><span class="post-meta-divider">-</span><a class="tag-item" href="/tags/%E5%AE%9E%E7%94%A8%E5%B0%8F%E5%B7%A5%E5%85%B7/" style="--text-color:var(--hty-text-color)"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="tag-name">实用小工具</span></a><a class="tag-item" href="/tags/%E8%84%9A%E6%9C%AC/" style="--text-color:var(--hty-text-color)"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="tag-name">脚本</span></a></span></div><div class="post-author"><div class="author-avatar"><img src="https://www.gravatar.com/avatar/170126958484dfae0e26934864b36b4e?s=20&amp;d=https%3A%2F%2Fcdn.jsdelivr.net%2Fgh%2FYunYouJun%2Fcdn%2Fimg%2Favatar%2Fnone.jpg"></div><span class="author-name">harumonia</span></div></div></header><section class="post-body" itemprop="articleBody"><div class="post-content markdown-body" style="--smc-primary:#0078E7"><p>公司服务器上的日志文件多年积压, 已经占用了很大一部分不必要的内存空间. 所以本篇将完成一个功能性脚本, 其内容是扫描过期的日志文件, 并对文件进行对应的操作.</p><p>好久没有写过 bash 脚本了, 本篇也算是对这项技能的一个温习吧.</p><a id="more"></a><h2 id="明确需求"><a href="#明确需求" class="headerlink" title="明确需求"></a>明确需求</h2><p>这个脚本最核心的目标是 <strong>清理过期的日志文件</strong> , 然后就是需要考虑如何进行清理(清理的逻辑).</p><p>文件是否需要被清理, 其依据文件的最后修改日期, 该内容可以通过 <code>ls -l</code> 或者 <code>date -r</code> 等命令实现.</p><p>在确定文件需要被清理之后, TL 给出的需求是, 6 个月 ~ 12 个月的清空, 大于 12 个月的删除. 这里比较敏感的是删除操作, 如果该文件被 python 的<code>open()</code> 之类的命令打开, 而没有被 <code>f.close()</code>, 文件的句柄无法释放, 强行使用 <code>rm</code> 命令无法达到空间释放的目的(需要进行重启才能释放句柄, 进而释放内存). 所以, 在进行删除操作之前, 最好看一下文件句柄的情况.</p><p>最后, 类似日期 \ 路径等参数, 最好是能够从外部输入, 这样最为灵活.</p><h2 id="开工"><a href="#开工" class="headerlink" title="开工"></a>开工</h2><h3 id="bash-复习"><a href="#bash-复习" class="headerlink" title="bash 复习"></a>bash 复习</h3><p>bash 脚本的学习与回顾强推 <a target="_blank" rel="noopener" href="https://wangdoc.com/bash/intro.html">Bash 脚本教程</a>, 其中对 bash 以及其引申的一些知识都做得很好.</p><p>预料中, 这个脚本需要用到的指令如下:</p><ul><li>find</li><li>readarray</li><li>rm</li><li>kill</li><li>echo</li></ul><p>另外, 条件判断 \ 循环 \ 函数 \ 数组这几项也需要有所了解.</p><h2 id="查找过期文件"><a href="#查找过期文件" class="headerlink" title="查找过期文件"></a>查找过期文件</h2><p>一开始笔者准备通过 <code>ls</code> + <code>awk</code> 来实现找到过期文件的目的的, 但是这样逻辑上会比较复杂, 后来想到可以直接使用 <code>find</code> 嘛~</p><p>核心代码如下, <code>-iname</code> 等相关的参数可以使用 <code>man find</code> 了解.</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># path_dir: 文件的路径</span>
<span class="token comment"># remove_timeline: 最后修改日期大于(+)这个时间则会被删除</span>

<span class="token function">find</span> <span class="token variable">$path_dir</span> -iname <span class="token string">"*.log*"</span> -atime +<span class="token variable">$remove_timeline</span> -type f<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h2 id="处理文件"><a href="#处理文件" class="headerlink" title="处理文件"></a>处理文件</h2><p>直接对 <em>find</em> 得到的结果进行遍历处理即可, 但是在实际操作之中, 去发现了一些比较奇怪的文件.</p><p>比如 <code>/logs/ example1.log</code>, 这个文件不知为何以 <em>空格</em> 开头, 这在对 find 的结果做切分时会被切分为两个子串, 不仅达不到我们的目的, 甚至会成为安全隐患.</p><p>所以在这里, 将 find 的结果进行预切分, 形成数组, 然后对每个元素进行清洗. 这里参考了<a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/10586153/how-to-split-a-string-into-an-array-in-bash">stackover flow</a>的回答, 其代码如下.</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># bash version >= 4.4</span>
<span class="token builtin class-name">readarray</span> -d <span class="token string">''</span> files_half_year_ago <span class="token operator">&lt;</span> <span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token function">find</span> <span class="token variable">$path_dir</span> -iname <span class="token string">"*.log*"</span> -atime -<span class="token variable">$remove_timeline</span> -atime +<span class="token variable">$clean_timeline</span> -type f -print0<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment"># bash version &lt; 4.4</span>
<span class="token comment"># files_half_year_ago=()</span>
<span class="token comment"># while IFS=  read -r -d $'\n'; do</span>
<span class="token comment">#     files_half_year_ago+=("$REPLY")</span>
<span class="token comment"># done &lt; &lt;(find $path_dir -iname "*.log*" -atime -$remove_timeline -atime +$clean_timeline -type f)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这里将 find 的结果存入了 <code>files_half_year_ago</code> 变量, 接下来使用 for 循环遍历该数组.</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function-name function">fine_handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token comment"># 文件处理函数</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">for</span> <span class="token for-or-select variable">filename</span> <span class="token keyword">in</span> <span class="token string">"<span class="token variable">$&#123;files_half_year_ago<span class="token punctuation">[</span>@<span class="token punctuation">]</span>&#125;</span>"</span><span class="token punctuation">;</span> <span class="token keyword">do</span>
    file_handler <span class="token string">"clean"</span> <span class="token variable">$filename</span>
<span class="token keyword">done</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>需要注意的是, <code>&quot;$&#123;files_half_year_ago[@]&#125;&quot;</code> 的双引号不能丢掉, 不然空格在遍历时仍然会作为拆分符号被使用.</p><p><code>file_handler</code> 函数接收两个参数, 第一个参数是操作, 如 “<em>clean</em>“. 第二个参数, 更严谨地说应该是第二组参数, 是文件的路径, 如果其中没有空格, 则就是一个字符串, 而如果其中有空格, 则会被作为两个字符串参数处理. 所以, 在函数接收参数时, 需要用一个取巧的办法.</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function-name function">file_handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token builtin class-name">local</span> <span class="token assign-left variable">option</span><span class="token operator">=</span><span class="token variable">$1</span>
    <span class="token builtin class-name">shift</span>
    <span class="token builtin class-name">local</span> <span class="token assign-left variable">file_name</span><span class="token operator">=</span><span class="token string">"<span class="token variable">$@</span>"</span>

    <span class="token punctuation">..</span>.
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这样, 即使路径因为分隔符而被作为多个参数传入了, 仍然会被约束为一个完整的字符串使用. 需要注意的是, 在后续的使用中都需要对 <em>filename</em> 变量添加双引号.</p><h2 id="文件操作"><a href="#文件操作" class="headerlink" title="文件操作"></a>文件操作</h2><p>至此, 我们已经能够顺利地遍历 <code>find</code> 的结果了. 接下来就是对文件进行操作.</p><p>正如前面的分析, 在对文件进行操作之前, 我们需要知道文件的句柄有没有被其他进程调用. 这里我的判断方法就是使用 <code>lsof</code> 查看文件使用被其他进程使用. 核心代码如下:</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">local</span> <span class="token assign-left variable">process_list</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">lsof</span> -t <span class="token string">"<span class="token variable">$file_name</span>"</span><span class="token variable">`</span></span>
<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token string">"<span class="token variable">$process_list</span>"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
    <span class="token function">kill</span> -9 <span class="token variable">$process_list</span>
<span class="token keyword">fi</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>这里将 <code>lsof</code> 的结果交给了 <em>process list</em> 变量, 然后进行判断, 如果 lsof 为空, 或者只有 1 个进程在调用, 则可以直接使用 <code>[ $process_list ]</code>, 但是当有多个进程调用时, 再使用这个命令就会出错了, 所以最保险的是如上代码所示, 使用双引号将 process_list 包起来.</p><p>到这里, 文件相关的进程被 kill 掉, 句柄自然也就释放了, 接下来进行文件操作也就无所顾忌.</p><ul><li>删除: <code>rm $file_name</code></li><li>清空: <code>echo &#39;&#39; &gt; $file_name</code></li></ul><h2 id="完整的脚本"><a href="#完整的脚本" class="headerlink" title="完整的脚本"></a>完整的脚本</h2><p>一个完整的脚本, 输入参数 \ 使用说明等内容都是缺不得的, 最好还要在各个处理阶段加上一些输出内容. 所以, 最终代码如下.</p><p>删除 \ 清空 这些敏感操作已经在展示代码中去除了, 可以自行在注释的位置添加.</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span>

<span class="token assign-left variable">remove_timeline</span><span class="token operator">=</span><span class="token number">365</span>
<span class="token assign-left variable">clean_timeline</span><span class="token operator">=</span><span class="token number">180</span>
<span class="token assign-left variable">path_dir</span><span class="token operator">=</span>-1
<span class="token assign-left variable">force_clean</span><span class="token operator">=</span><span class="token number">0</span>

<span class="token function-name function">Help</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
   <span class="token builtin class-name">echo</span> <span class="token string">"Log clean tool."</span>
   <span class="token builtin class-name">echo</span>
   <span class="token builtin class-name">echo</span> <span class="token string">"Syntax: scriptTemplate [-p|h|t|T|v]"</span>
   <span class="token builtin class-name">echo</span> <span class="token string">"options:"</span>
   <span class="token builtin class-name">echo</span> <span class="token string">"-p     Path of log files."</span>
   <span class="token builtin class-name">echo</span> <span class="token string">"-f     Force clean | remove files. It will kill the releated process."</span>
   <span class="token builtin class-name">echo</span> <span class="token string">"-h     Print this Help."</span>
   <span class="token builtin class-name">echo</span> <span class="token string">"-v     Verbose mode."</span>
   <span class="token builtin class-name">echo</span> <span class="token string">"-T     Num of days. File modified time over than this nums will be delete. default 365"</span>
   <span class="token builtin class-name">echo</span> <span class="token string">"-t     Num of days. File modified time over than this nums will be clean. default 180"</span>
   <span class="token builtin class-name">echo</span>
<span class="token punctuation">&#125;</span>

<span class="token function-name function">file_handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token builtin class-name">local</span> <span class="token assign-left variable">option</span><span class="token operator">=</span><span class="token variable">$1</span>
    <span class="token builtin class-name">shift</span>
    <span class="token builtin class-name">local</span> <span class="token assign-left variable">file_name</span><span class="token operator">=</span><span class="token string">"<span class="token variable">$@</span>"</span>

    <span class="token keyword">if</span> <span class="token operator">!</span> <span class="token punctuation">[</span> <span class="token string">"<span class="token variable">$file_name</span>"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
        <span class="token builtin class-name">echo</span> <span class="token string">"invalid filename: <span class="token variable">$file_name</span> , skip it"</span>
        <span class="token builtin class-name">return</span>
    <span class="token keyword">fi</span>

    <span class="token builtin class-name">local</span> <span class="token assign-left variable">process_list</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">lsof</span> -t <span class="token string">"<span class="token variable">$file_name</span>"</span><span class="token variable">`</span></span>
    <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token string">"<span class="token variable">$process_list</span>"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
        <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$force_clean</span> -eq <span class="token number">1</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
            <span class="token function">kill</span> -9 <span class="token variable">$process_list</span>
        <span class="token keyword">else</span>
            <span class="token builtin class-name">printf</span> <span class="token string">"file <span class="token variable">$file_name</span> is been used,<span class="token entity" title="\n">\n</span>process pid:<span class="token entity" title="\n">\n</span>--------<span class="token entity" title="\n">\n</span><span class="token variable">$process_list</span><span class="token entity" title="\n">\n</span>--------<span class="token entity" title="\n">\n</span>skip it<span class="token entity" title="\n">\n</span>"</span>
            <span class="token builtin class-name">continue</span>
        <span class="token keyword">fi</span>
    <span class="token keyword">fi</span>

    <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$option</span> <span class="token operator">==</span> <span class="token string">"delete"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
        <span class="token builtin class-name">echo</span> <span class="token string">"delete"</span> <span class="token variable">$file_name</span>
        <span class="token comment"># 删除操作</span>
    <span class="token keyword">elif</span> <span class="token punctuation">[</span> <span class="token variable">$option</span> <span class="token operator">==</span> <span class="token string">"clean"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
        <span class="token builtin class-name">echo</span> <span class="token string">"clean"</span> <span class="token variable">$file_name</span>
        <span class="token comment"># 清空操作</span>
    <span class="token keyword">else</span>
        <span class="token builtin class-name">echo</span> <span class="token string">"invalid option"</span>
    <span class="token keyword">fi</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">while</span> <span class="token builtin class-name">getopts</span> <span class="token string">"hvfp:t:T:"</span> option<span class="token punctuation">;</span> <span class="token keyword">do</span>
   <span class="token keyword">case</span> <span class="token variable">$option</span> <span class="token keyword">in</span>
        f<span class="token punctuation">)</span>
            <span class="token assign-left variable">force_clean</span><span class="token operator">=</span><span class="token number">1</span>
            <span class="token punctuation">;</span><span class="token punctuation">;</span>
        h<span class="token punctuation">)</span>
            Help
            <span class="token builtin class-name">exit</span> <span class="token number">0</span>
            <span class="token punctuation">;</span><span class="token punctuation">;</span>
        p<span class="token punctuation">)</span>
            <span class="token assign-left variable">path_dir</span><span class="token operator">=</span><span class="token string">"<span class="token variable">$OPTARG</span>"</span>
            <span class="token punctuation">;</span><span class="token punctuation">;</span>
        <span class="token function">v</span><span class="token punctuation">)</span>
            <span class="token builtin class-name">echo</span> <span class="token string">"to be continue"</span>
            <span class="token builtin class-name">exit</span> <span class="token number">1</span>
            <span class="token punctuation">;</span><span class="token punctuation">;</span>
        T<span class="token punctuation">)</span>
            <span class="token assign-left variable">remove_timeline</span><span class="token operator">=</span><span class="token string">"<span class="token variable">$OPTARG</span>"</span>
            <span class="token punctuation">;</span><span class="token punctuation">;</span>
        t<span class="token punctuation">)</span>
            <span class="token assign-left variable">clean_timeline</span><span class="token operator">=</span><span class="token string">"<span class="token variable">$OPTARG</span>"</span>
            <span class="token punctuation">;</span><span class="token punctuation">;</span>
        ?<span class="token punctuation">)</span>
            <span class="token builtin class-name">echo</span> <span class="token string">"script usage: <span class="token variable"><span class="token variable">$(</span><span class="token function">basename</span> $0<span class="token variable">)</span></span> [-v] [-h] [-f] [-p] [-t] [-T]"</span> <span class="token operator">></span><span class="token file-descriptor important">&amp;2</span>
            <span class="token builtin class-name">exit</span> <span class="token number">1</span>
            <span class="token punctuation">;</span><span class="token punctuation">;</span>
   <span class="token keyword">esac</span>
<span class="token keyword">done</span>
<span class="token builtin class-name">shift</span> <span class="token string">"<span class="token variable"><span class="token variable">$((</span>$OPTIND <span class="token operator">-</span> <span class="token number">1</span><span class="token variable">))</span></span>"</span>

<span class="token comment"># echo "$remove_timeline , $clean_timeline , $path_dir"</span>

<span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token variable">$remove_timeline</span> -lt <span class="token variable">$clean_timeline</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
    <span class="token builtin class-name">echo</span> <span class="token string">"Error: value of -T must more than value of -t."</span>
    <span class="token builtin class-name">exit</span> <span class="token number">1</span>
<span class="token keyword">fi</span>

<span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token variable">$path_dir</span> <span class="token operator">==</span> <span class="token string">"-1"</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
    <span class="token builtin class-name">echo</span> <span class="token string">"Error: -p arg is required."</span>
    <span class="token builtin class-name">exit</span> <span class="token number">1</span>
<span class="token keyword">fi</span>

<span class="token builtin class-name">echo</span> <span class="token string">"<span class="token variable">$remove_timeline</span> , <span class="token variable">$clean_timeline</span> , <span class="token variable">$path_dir</span>"</span>

<span class="token comment"># v4.4+</span>
<span class="token builtin class-name">readarray</span> -d <span class="token string">''</span> files_half_year_ago <span class="token operator">&lt;</span> <span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token function">find</span> <span class="token variable">$path_dir</span> -iname <span class="token string">"*.log*"</span> -atime -<span class="token variable">$remove_timeline</span> -atime +<span class="token variable">$clean_timeline</span> -type f -print0<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token builtin class-name">readarray</span> -d <span class="token string">''</span> files_year_ago <span class="token operator">&lt;</span> <span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token function">find</span> <span class="token variable">$path_dir</span> -iname <span class="token string">"*.log*"</span> -atime -<span class="token variable">$remove_timeline</span> -type f -print0<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment"># declare -p files_year_ago;</span>

<span class="token comment"># v4.4-</span>
<span class="token comment"># files_year_ago=()</span>
<span class="token comment"># while IFS=  read -r -d $'\n'; do</span>
<span class="token comment">#     files_year_ago+=("$REPLY")</span>
<span class="token comment"># done &lt; &lt;(find $path_dir -iname "*.log*" -atime +$remove_timeline -type f)</span>

<span class="token comment"># files_half_year_ago=()</span>
<span class="token comment"># while IFS=  read -r -d $'\n'; do</span>
<span class="token comment">#     files_half_year_ago+=("$REPLY")</span>
<span class="token comment"># done &lt; &lt;(find $path_dir -iname "*.log*" -atime -$remove_timeline -atime +$clean_timeline -type f)</span>


<span class="token keyword">for</span> <span class="token for-or-select variable">filename</span> <span class="token keyword">in</span> <span class="token string">"<span class="token variable">$&#123;files_half_year_ago<span class="token punctuation">[</span>@<span class="token punctuation">]</span>&#125;</span>"</span><span class="token punctuation">;</span> <span class="token keyword">do</span>
    file_handler <span class="token string">"clean"</span> <span class="token variable">$filename</span>
<span class="token keyword">done</span>

<span class="token keyword">for</span> <span class="token for-or-select variable">filename</span> <span class="token keyword">in</span> <span class="token string">"<span class="token variable">$&#123;files_year_ago<span class="token punctuation">[</span>@<span class="token punctuation">]</span>&#125;</span>"</span><span class="token punctuation">;</span> <span class="token keyword">do</span>
    file_handler <span class="token string">"delete"</span> <span class="token variable">$filename</span>
<span class="token keyword">done</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><div id="reward-container"><span class="hty-icon-button button-glow" id="reward-button" title="打赏" onclick="var qr = document.getElementById(&quot;qr&quot;); qr.style.display = (qr.style.display === &quot;none&quot;) ? &quot;block&quot; : &quot;none&quot;;"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-hand-coin-line"></use></svg></span><div id="reward-comment">I'm so cute. Please give me money.</div><div id="qr" style="display:none"><div style="display:inline-block"><a target="_blank" rel="noopener" href="https://harumona-blog.oss-cn-beijing.aliyuncs.com/blog/IMG_3741.JPG"><img loading="lazy" src="https://harumona-blog.oss-cn-beijing.aliyuncs.com/blog/IMG_3741.JPG" alt="支付宝" title="支付宝"></a><div><span style="color:#00a3ee"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-alipay-line"></use></svg></span></div></div><div style="display:inline-block"></div><div style="display:inline-block"><a target="_blank" rel="noopener" href="https://harumona-blog.oss-cn-beijing.aliyuncs.com/blog/IMG_3742.JPG"><img loading="lazy" src="https://harumona-blog.oss-cn-beijing.aliyuncs.com/blog/IMG_3742.JPG" alt="微信支付" title="微信支付"></a><div><span style="color:#2dc100"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-wechat-pay-line"></use></svg></span></div></div></div></div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者：</strong>harumonia</li><li class="post-copyright-link"><strong>本文链接：</strong><a href="https://blog.harumonia.moe/clean-logs/" title="bash脚本 - 过期日志文件清理">https://blog.harumonia.moe/clean-logs/</a></li><li class="post-copyright-license"><strong>版权声明：</strong>本博客所有文章除特别声明外，均默认采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener" title="CC BY-NC-SA 4.0 "><svg class="icon"><use xlink:href="#icon-creative-commons-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-by-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-nc-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-sa-line"></use></svg></a>许可协议。</li></ul></section></article><div class="post-nav"><div class="post-nav-item"><a class="post-nav-prev" href="/my-2021/" rel="prev" title="2021"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-left-s-line"></use></svg><span class="post-nav-text">2021</span></a></div><div class="post-nav-item"><a class="post-nav-next" href="/pdfplumber-memory-leak/" rel="next" title="pdfplumber内存泄露问题解决方案(施工中)"><span class="post-nav-text">pdfplumber内存泄露问题解决方案(施工中)</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-right-s-line"></use></svg></a></div></div></div><div class="hty-card" id="comment"><div class="comment-tooltip text-center"><span>要不要和我说些什么？</span><br></div></div></main><footer class="sidebar-translate" id="footer"><div class="copyright"><span>&copy; 2018 – 2022 </span><span class="with-love" id="animate"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-cloud-line"></use></svg></span><span class="author">harumonia</span></div><div class="live_time"><span>本博客已萌萌哒地运行</span><span id="display_live_time"></span><span class="moe-text">(●'◡'●)</span><script>function blog_live_time() {
  setTimeout(blog_live_time, 1000);
  const start = new Date('2018-10-25T00:00:00');
  const now = new Date();
  const timeDiff = (now.getTime() - start.getTime());
  const msPerMinute = 60 * 1000;
  const msPerHour = 60 * msPerMinute;
  const msPerDay = 24 * msPerHour;
  const passDay = Math.floor(timeDiff / msPerDay);
  const passHour = Math.floor((timeDiff % msPerDay) / 60 / 60 / 1000);
  const passMinute = Math.floor((timeDiff % msPerHour) / 60 / 1000);
  const passSecond = Math.floor((timeDiff % msPerMinute) / 1000);
  display_live_time.innerHTML = " " + passDay + " 天 " + passHour + " 小时 " + passMinute + " 分 " + passSecond + " 秒";
}
blog_live_time();</script></div></footer><a class="hty-icon-button" id="back-to-top" aria-label="back-to-top" href="#"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-up-s-line"></use></svg><svg class="progress-circle-container" viewBox="0 0 100 100"><circle class="progress-circle" id="progressCircle" cx="50" cy="50" r="48" fill="none" stroke="#0078E7" stroke-width="2" stroke-linecap="round"></circle></svg></a><a class="popup-trigger hty-icon-button icon-search" id="search" target="_blank" rel="noopener" href="https://www.google.com/search?q=site:harumonia.moe" title="搜索"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-search-line"></use></svg></span></a></div></body></html>